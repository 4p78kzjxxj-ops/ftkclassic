<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTK Classic – Bingo Bango Bongo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" type="image/png" href="IMG_7296.jpg" />
  <style>
    :root{
      /* Modern 2025-ish palette + elevation */
      --bg0:#0b1220;
      --bg1:#0f172a;
      --glass:rgba(255,255,255,.06);
      --glass2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.12);
      --text:#e5e7eb;
      --muted:rgba(229,231,235,.72);
      --muted2:rgba(229,231,235,.55);

      --accent:#60a5fa;       /* blue */
      --accent2:#34d399;      /* green */
      --warn:#fb923c;         /* orange */
      --danger:#f87171;       /* red */

      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --shadow2: 0 8px 24px rgba(0,0,0,.28);

      --r-xl: 22px;
      --r-lg: 18px;
      --r-md: 14px;

      --tap: 46px;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    html,body{height:100%;-webkit-text-size-adjust:100%;}
    body{
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.35), transparent 55%),
        radial-gradient(900px 520px at 90% 10%, rgba(52,211,153,.26), transparent 55%),
        radial-gradient(800px 500px at 40% 110%, rgba(251,146,60,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100%;
      padding: 12px;
      padding-bottom: calc(88px + var(--safe-bottom));
      touch-action: manipulation;
    }
    @media (min-width: 900px){
      body{max-width:980px;margin:0 auto;padding:18px;padding-bottom: calc(92px + var(--safe-bottom));}
    }

    a{color:inherit;text-decoration:none;-webkit-tap-highlight-color:transparent;}
    button{border:0;background:none;color:inherit;-webkit-tap-highlight-color:transparent;}
    :focus-visible{outline:2px solid rgba(96,165,250,.75);outline-offset:2px;border-radius:12px;}

    /* ====== Top App Bar ====== */
    .appbar{
      position: sticky;
      top: calc(10px + var(--safe-top));
      z-index: 60;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--r-xl);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .brand{
      display:flex;align-items:center;gap:10px;min-width:0;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;object-fit:cover;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      flex-shrink:0;
    }
    .brand-text{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .title{font-weight:900;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .subtitle{font-size:.82rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .appbar-actions{display:flex;align-items:center;gap:8px;}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      font-size: .86rem;
      color: var(--text);
      max-width: 200px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chip strong{font-weight:900;}
    .menuBtn{
      height: 40px; min-width: 40px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      display:inline-flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      cursor:pointer;
      font-size: 18px;
    }

    .menu-overlay{
      position:fixed;inset:0;display:none;z-index:999;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .menu-sheet{
      position: fixed;
      left: 12px; right: 12px;
      top: calc(64px + var(--safe-top));
      z-index: 1000;
      display:none;
      border-radius: var(--r-xl);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.07));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .menu-sheet a{
      display:flex;align-items:center;justify-content:space-between;
      padding: 14px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      font-weight: 750;
      color: var(--text);
    }
    .menu-sheet a:first-child{border-top:none;}
    .menu-sheet a:hover{background: rgba(255,255,255,.06);}
    .menu-sheet .hintline{font-size:.82rem;color:var(--muted);font-weight:600;}

    /* ====== Layout blocks ====== */
    main{margin-top: 12px;display:flex;flex-direction:column;gap:12px;}
    .card{
      border-radius: var(--r-xl);
      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.06));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 14px;
    }

    .section-title{
      font-size:.78rem;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: var(--muted2);
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .hint{font-size:.92rem;color:var(--muted);line-height:1.35rem;}
    .divider{height:1px;background:rgba(255,255,255,.09);margin:12px 0;}

    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:end;margin-top:10px;}
    label{display:flex;flex-direction:column;gap:6px;min-width: 210px;}
    select, input{
      height: var(--tap);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(2,6,23,.35);
      color: var(--text);
      padding: 0 12px;
      font-size: 1rem;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    select option{background:#0b1220;color:var(--text);}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: .9rem;
      color: var(--text);
      height: var(--tap);
      white-space:nowrap;
    }
    .pill.good{border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.10); color: #bbf7d0;}

    .btn{
      height: var(--tap);
      border-radius: 999px;
      padding: 0 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight: 900;
      letter-spacing:.1px;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      gap: 10px;
      box-shadow: 0 12px 28px rgba(0,0,0,.20);
    }
    .btn:active{transform: translateY(1px);}
    .btn-primary{
      background: linear-gradient(180deg, rgba(96,165,250,.95), rgba(59,130,246,.75));
      border-color: rgba(96,165,250,.6);
      color: #071123;
    }
    .btn-warn{
      background: linear-gradient(180deg, rgba(251,146,60,.35), rgba(251,146,60,.18));
      border-color: rgba(251,146,60,.35);
      color: #ffe6d0;
    }

    .err{
      margin-top:10px;
      font-size:.92rem;
      color:#fecaca;
      background: rgba(248,113,113,.10);
      border: 1px solid rgba(248,113,113,.28);
      padding: 10px 12px;
      border-radius: 16px;
      display:none;
    }
    .status{margin-top:8px;font-size:.9rem;color:var(--muted);min-height:1.1em;}

    /* Sticky leaderboard (compact, modern) */
    .sticky-lb{
      position: sticky;
      top: calc(78px + var(--safe-top));
      z-index: 55;
      padding: 12px 14px;
    }
    .sticky-lb.sticky-hidden{display:none;}
    .sticky-meta{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px;}
    .sticky-list{display:flex;flex-direction:column;gap:8px;margin-top:12px;}

    .sticky-row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(2,6,23,.25);
    }
    .sticky-left{display:flex;gap:10px;align-items:center;min-width:0;}
    .rankBubble{
      width: 28px;height:28px;border-radius: 999px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(96,165,250,.18);
      border: 1px solid rgba(96,165,250,.25);
      font-weight: 950;
      font-size: .85rem;
      flex-shrink:0;
    }
    .sticky-name{
      font-weight: 950;
      min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .sticky-sub{font-size:.82rem;color:var(--muted);white-space:nowrap;}
    .sticky-total{
      font-weight: 950;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
      flex-shrink:0;
    }

    /* Score grid */
    .score-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px;}
    .player-card{
      border-radius: var(--r-xl);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(2,6,23,.22);
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.20);
      transition: transform .08s ease, border-color .08s ease, background .08s ease;
    }
    .player-card:hover{transform: translateY(-1px);border-color: rgba(96,165,250,.28);background: rgba(2,6,23,.28);}
    .player-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .player-name{font-size:1.05rem;font-weight: 950;letter-spacing:.2px;}
    .total-pill{
      font-size:.9rem;
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }

    .bbb-row{display:grid;grid-template-columns: 1fr 1fr 1fr;gap:10px;}
    @media (max-width:430px){ .bbb-row{grid-template-columns: 1fr;} }

    .bbb-box{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding: 12px;
      display:flex;flex-direction:column;gap:10px;
    }
    .bbb-title{font-size:.72rem;letter-spacing:.14em;text-transform:uppercase;color:var(--muted2);font-weight: 950;}
    .bbb-score{font-size:1.35rem;font-weight: 1000;letter-spacing:.3px;}
    .bbb-actions{display:flex;gap:10px;flex-wrap:wrap;}
    .mini{
      height: 40px;
      border-radius: 999px;
      padding: 0 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight: 1000;
      cursor:pointer;
    }
    .mini:active{transform: translateY(1px);}
    .mini[data-action="inc"]{border-color: rgba(52,211,153,.25); background: rgba(52,211,153,.10);}
    .mini[data-action="dec"]{border-color: rgba(248,113,113,.22); background: rgba(248,113,113,.08);}

    /* Player picker */
    .player-pick-list{display:flex;flex-direction:column;gap:10px;margin-top:12px;}
    .pick-row{
      display:flex;align-items:center;gap:12px;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(2,6,23,.22);
    }
    .pick-row input{width:20px;height:20px;accent-color: var(--accent);}
    .pick-name{font-weight: 950;}
    .pick-sub{font-size:.85rem;color:var(--muted);}

    /* Bottom bar */
    .bottom-bar{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      padding: 12px;
      padding-bottom: calc(12px + var(--safe-bottom));
      z-index: 80;
      pointer-events:none;
    }
    .bottom-inner{
      pointer-events:auto;
      max-width: 980px;
      margin: 0 auto;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.07));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .bottom-left{
      display:flex;flex-direction:column;gap:2px;min-width:0;
      padding-left: 10px;
    }
    .bottom-title{font-weight: 950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .bottom-sub{font-size:.82rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .bottom-actions{display:flex;gap:10px;align-items:center;}
    .bottom-actions .btn{height: 44px;}

    /* Hide desktop nav buttons (we use menu sheet) */
    .nav-desktop{display:none;}
  </style>
</head>
<body>
  <div id="menuOverlay" class="menu-overlay"></div>

  <!-- App Bar -->
  <header class="appbar">
    <div class="brand">
      <img src="IMG_7296.jpg" alt="FTK Classic logo" class="logo" />
      <div class="brand-text">
        <div class="title">FTK Classic</div>
        <div class="subtitle">Bingo Bango Bongo</div>
      </div>
    </div>

    <div class="appbar-actions">
      <div class="chip" id="sessionChip" title="Session">
        <span style="opacity:.8">Session</span>
        <strong id="sessionLabel">Not started</strong>
      </div>

      <button id="hamburgerBtn" class="menuBtn" aria-label="Menu" aria-expanded="false">☰</button>
    </div>

    <!-- Menu Sheet -->
    <div id="hamburgerMenu" class="menu-sheet" aria-label="Navigation Menu">
      <a href="index.html"><span>Home</span><span class="hintline">FTK Classic</span></a>
      <a href="spectator.html"><span>Scores</span><span class="hintline">Live totals</span></a>
      <a href="games.html"><span>Games</span><span class="hintline">Choose a game</span></a>
      <a href="game_history.html"><span>Game History</span><span class="hintline">Past games</span></a>
    </div>
  </header>

  <main>
    <!-- Sticky leaderboard at top -->
    <section id="stickyLb" class="card sticky-lb sticky-hidden">
      <div class="section-title">
        <span>Leaderboard</span>
        <span style="font-size:.78rem;color:var(--muted);letter-spacing:0;text-transform:none;font-weight:800;">
          Total points
        </span>
      </div>

      <div class="sticky-meta">
        <span class="pill" id="holeMetaPill">—</span>
        <span class="pill" id="holeAwardPill">Hole awards: 0 / 3</span>
      </div>

      <div id="stickyList" class="sticky-list"></div>
    </section>

    <!-- Course & hole -->
    <section class="card">
      <div class="section-title">Course & hole</div>
      <div class="hint">
        Tracks a <strong>current hole</strong>. Once <strong>3 total points</strong> are awarded on a hole, it advances to the next hole.
      </div>

      <div class="controls">
        <label>
          <span class="hint" style="font-size:.85rem;">Course</span>
          <select id="courseSelect">
            <option value="southern_oaks">Southern Oaks</option>
          </select>
        </label>

        <label>
          <span class="hint" style="font-size:.85rem;">Current hole</span>
          <select id="holeSelect"></select>
        </label>
      </div>
    </section>

    <!-- Start session (only shown when no session is active) -->
    <section id="startCard" class="card">
      <div class="section-title">Start</div>
      <div class="hint">Select players, then start a new session.</div>

      <div class="controls">
        <button id="newSessionBtn" class="btn btn-primary" type="button">Start new session</button>
      </div>

      <div id="status" class="status"></div>
      <div id="error" class="err"></div>

      <div id="pickWrap" style="margin-top:12px;">
        <div class="section-title" style="margin-bottom:10px;">Select players</div>
        <div id="pickList" class="player-pick-list">
          <div class="hint">Loading players…</div>
        </div>
      </div>
    </section>

    <!-- Scoreboard -->
    <section class="card">
      <div class="section-title">Scoreboard</div>
      <div class="hint">Tap + / − to add points. Totals update automatically.</div>
      <div id="scoreGrid" class="score-grid">
        <div class="hint">Start a session to begin scoring.</div>
      </div>
    </section>
  </main>

  <!-- Bottom bar with End Session (only active during session) -->
  <div id="bottomBar" class="bottom-bar" style="display:none;">
    <div class="bottom-inner">
      <div class="bottom-left">
        <div class="bottom-title" id="bottomTitle">Session live</div>
        <div class="bottom-sub" id="bottomSub">Use the scoreboard to track points</div>
      </div>
      <div class="bottom-actions">
        <button id="endSessionBtn" class="btn btn-warn" type="button">End session</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5fk91DPgPBkJ3_xGnNntD3PQbi5Ib3kg",
      authDomain: "ftkclassicdb.firebaseapp.com",
      databaseURL: "https://ftkclassicdb-default-rtdb.firebaseio.com",
      projectId: "ftkclassicdb",
      storageBucket: "ftkclassicdb.firebasestorage.app",
      messagingSenderId: "963469808092",
      appId: "1:963469808092:web:e6e789ce20ef46404b3f19"
    };

    const COURSES = {
      southern_oaks: {
        name: "Southern Oaks",
        holes: [
          { n:1,  par:4, yards:343 }, { n:2,  par:4, yards:316 }, { n:3,  par:4, yards:364 },
          { n:4,  par:3, yards:142 }, { n:5,  par:5, yards:484 }, { n:6,  par:3, yards:202 },
          { n:7,  par:5, yards:578 }, { n:8,  par:4, yards:305 }, { n:9,  par:4, yards:363 },
          { n:10, par:4, yards:405 }, { n:11, par:3, yards:171 }, { n:12, par:4, yards:344 },
          { n:13, par:3, yards:138 }, { n:14, par:4, yards:279 }, { n:15, par:5, yards:516 },
          { n:16, par:4, yards:346 }, { n:17, par:4, yards:333 }, { n:18, par:5, yards:471 }
        ]
      }
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    async function ensureAnonAuth(){
      return new Promise((resolve,reject)=>{
        const unsub = onAuthStateChanged(auth, async (user)=>{
          try{
            if(user){ unsub(); return resolve(user); }
            const cred = await signInAnonymously(auth);
            unsub();
            resolve(cred.user);
          }catch(e){
            unsub(); reject(e);
          }
        });
      });
    }

    const els = {
      courseSelect: document.getElementById("courseSelect"),
      holeSelect: document.getElementById("holeSelect"),
      holeMetaPill: document.getElementById("holeMetaPill"),
      holeAwardPill: document.getElementById("holeAwardPill"),

      sessionLabel: document.getElementById("sessionLabel"),
      sessionChip: document.getElementById("sessionChip"),

      startCard: document.getElementById("startCard"),
      newSessionBtn: document.getElementById("newSessionBtn"),
      bottomBar: document.getElementById("bottomBar"),
      endSessionBtn: document.getElementById("endSessionBtn"),
      bottomTitle: document.getElementById("bottomTitle"),
      bottomSub: document.getElementById("bottomSub"),

      pickWrap: document.getElementById("pickWrap"),
      pickList: document.getElementById("pickList"),

      scoreGrid: document.getElementById("scoreGrid"),
      status: document.getElementById("status"),
      error: document.getElementById("error"),

      stickyLb: document.getElementById("stickyLb"),
      stickyList: document.getElementById("stickyList"),

      hamburgerBtn: document.getElementById("hamburgerBtn"),
      hamburgerMenu: document.getElementById("hamburgerMenu"),
      menuOverlay: document.getElementById("menuOverlay")
    };

    function setError(msg){
      els.error.textContent = msg || "";
      els.error.style.display = msg ? "block" : "none";
    }
    function setStatus(msg){ els.status.textContent = msg || ""; }
    function safeText(s){
      return String(s||"").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }
    function qp(){
      const p = new URLSearchParams(location.search || "");
      const o = {};
      for (const [k,v] of p.entries()) o[k]=v;
      return o;
    }

    // Menu sheet
    function openMenu(){
      els.hamburgerMenu.style.display="block";
      els.menuOverlay.style.display="block";
      els.hamburgerBtn.setAttribute("aria-expanded","true");
    }
    function closeMenu(){
      els.hamburgerMenu.style.display="none";
      els.menuOverlay.style.display="none";
      els.hamburgerBtn.setAttribute("aria-expanded","false");
    }
    els.hamburgerBtn?.addEventListener("click",(e)=>{
      e.stopPropagation();
      (els.hamburgerMenu.style.display==="block") ? closeMenu() : openMenu();
    });
    els.menuOverlay?.addEventListener("click", closeMenu);
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeMenu(); });

    // State
    let players = {};
    let selected = new Set();
    let sessionId = qp().session || null;
    let lastSnapshot = null;
    let currentCourseKey = els.courseSelect.value || "southern_oaks";

    const playersRef = ref(db, "players");
    const sessionsRootRef = ref(db, "games/bingoBangoBongo/sessions");

    function sessionRoot(id){ return ref(db, `games/bingoBangoBongo/sessions/${id}`); }
    function sessionLogRef(id){ return ref(db, `games/bingoBangoBongo/sessions/${id}/log`); }

    // Game numbering map (sid -> Game #)
    let gameNumMap = {};
    function computeGameNumbers(allSessions){
      const arr = Object.entries(allSessions || {}).map(([sid, sess]) => ({
        sid,
        createdAt: Number(sess?.createdAt || 0)
      }));
      arr.sort((a,b) => (a.createdAt - b.createdAt) || a.sid.localeCompare(b.sid));
      const map = {};
      arr.forEach((x,i)=> { map[x.sid] = i+1; });
      return map;
    }
    function setSessionLabel(){
      if (!sessionId){ els.sessionLabel.textContent = "Not started"; return; }
      const n = gameNumMap[sessionId];
      els.sessionLabel.textContent = n ? `Game ${n}` : "Game";
    }

    function buildHoleSelect(){
      const course = COURSES[currentCourseKey];
      els.holeSelect.innerHTML = course.holes.map(h => `<option value="${h.n}">Hole ${h.n}</option>`).join("");
    }
    function setHoleMeta(holeNum){
      const course = COURSES[currentCourseKey];
      const h = course.holes.find(x => x.n === Number(holeNum));
      if (!h){ els.holeMetaPill.textContent = "—"; return; }
      els.holeMetaPill.textContent = `Hole ${h.n} · Par ${h.par} · ${h.yards} yds`;
    }
    function setHoleAwardCount(count){
      const c = Number(count||0);
      els.holeAwardPill.textContent = `Hole awards: ${c} / 3`;
      els.holeAwardPill.className = "pill" + (c >= 3 ? " good" : "");
    }

    function renderPlayerPicker(){
      const ids = Object.keys(players || {});
      if (!ids.length){
        els.pickList.innerHTML = `<div class="hint">No players found.</div>`;
        return;
      }
      ids.sort((a,b)=> (players[a]?.name||"").localeCompare(players[b]?.name||""));

      els.pickList.innerHTML = ids.map(pid=>{
        const p = players[pid] || {};
        const checked = selected.has(pid) ? "checked" : "";
        return `
          <label class="pick-row">
            <input type="checkbox" data-pick="${safeText(pid)}" ${checked} />
            <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
              <div class="pick-name">${safeText(p.name||"Unknown")}</div>
              <div class="pick-sub">&nbsp;</div>
            </div>
          </label>
        `;
      }).join("");
    }

    function getScore(scoresObj, pid){
      const s = scoresObj?.[pid] || {};
      const bingo = Number(s.bingo||0);
      const bango = Number(s.bango||0);
      const bongo = Number(s.bongo||0);
      return { bingo, bango, bongo, total: bingo+bango+bongo };
    }

    function scoreBoxHtml(pid, bucket, title, val){
      return `
        <div class="bbb-box">
          <div class="bbb-title">${safeText(title)}</div>
          <div class="bbb-score">${val}</div>
          <div class="bbb-actions">
            <button class="mini" data-action="inc" data-bucket="${safeText(bucket)}" data-pid="${safeText(pid)}">+1</button>
            <button class="mini" data-action="dec" data-bucket="${safeText(bucket)}" data-pid="${safeText(pid)}">−1</button>
          </div>
        </div>
      `;
    }

    function renderStickyLeaderboard(sessionPlayersObj, scoresObj){
      const pids = Object.keys(sessionPlayersObj || {});
      if (!pids.length){
        els.stickyLb.classList.add("sticky-hidden");
        els.stickyList.innerHTML = "";
        return;
      }

      const rows = pids.map(pid=>{
        const name = players[pid]?.name || sessionPlayersObj[pid]?.name || "Player";
        const s = getScore(scoresObj, pid);
        return { pid, name, ...s };
      });

      rows.sort((a,b)=> b.total - a.total || b.bingo - a.bingo || b.bango - a.bango || b.bongo - a.bongo || a.name.localeCompare(b.name));

      els.stickyLb.classList.remove("sticky-hidden");

      els.stickyList.innerHTML = rows.map((r, idx)=>`
        <div class="sticky-row">
          <div class="sticky-left">
            <div class="rankBubble">${idx+1}</div>
            <div style="min-width:0;">
              <div class="sticky-name">${safeText(r.name)}</div>
              <div class="sticky-sub">B ${r.bingo} · Ba ${r.bango} · Bo ${r.bongo}</div>
            </div>
          </div>
          <div class="sticky-total">Total ${r.total}</div>
        </div>
      `).join("");
    }

    function renderScoreboard(sessionPlayersObj, scoresObj){
      const pids = Object.keys(sessionPlayersObj || {});
      if (!pids.length){
        els.scoreGrid.innerHTML = `<div class="hint">No players in this session.</div>`;
        return;
      }

      pids.sort((a,b)=>{
        const na = players[a]?.name || sessionPlayersObj[a]?.name || "";
        const nb = players[b]?.name || sessionPlayersObj[b]?.name || "";
        return na.localeCompare(nb);
      });

      els.scoreGrid.innerHTML = pids.map(pid=>{
        const name = players[pid]?.name || sessionPlayersObj[pid]?.name || "Player";
        const s = getScore(scoresObj, pid);
        return `
          <div class="player-card" data-pid="${safeText(pid)}">
            <div class="player-head">
              <div class="player-name">${safeText(name)}</div>
              <div class="total-pill"><strong>Total: ${s.total}</strong></div>
            </div>
            <div class="bbb-row">
              ${scoreBoxHtml(pid, "bingo", "Bingo", s.bingo)}
              ${scoreBoxHtml(pid, "bango", "Bango", s.bango)}
              ${scoreBoxHtml(pid, "bongo", "Bongo", s.bongo)}
            </div>
          </div>
        `;
      }).join("");
    }

    async function startNewSession(){
      setError(""); setStatus("");

      const chosen = Array.from(selected);
      if (chosen.length < 1){
        setError("Select at least 1 player.");
        return;
      }

      try{
        await ensureAnonAuth();
        setStatus("Creating session…");

        const newRef = push(sessionsRootRef);

        const playersObj = {};
        const scoresObj = {};
        chosen.forEach(pid=>{
          playersObj[pid] = { name: players[pid]?.name || "Player" };
          scoresObj[pid] = { bingo: 0, bango: 0, bongo: 0 };
        });

        const courseKey = els.courseSelect.value || "southern_oaks";

        await set(newRef, {
          createdAt: Date.now(),
          createdAtServer: serverTimestamp(),
          status: "live",
          game: "bingoBangoBongo",
          courseKey,
          courseName: COURSES[courseKey]?.name || "Course",
          currentHole: 1,
          players: playersObj,
          scores: scoresObj
        });

        sessionId = newRef.key;
        const url = new URL(location.href);
        url.searchParams.set("session", sessionId);
        location.href = url.toString();
      }catch(e){
        console.error(e);
        setError("Create failed: " + (e?.code || e?.message || "unknown"));
        setStatus("");
      }
    }

    async function endSession(){
      if (!sessionId) return;

      const ok = window.confirm("Are you sure?");
      if (!ok) return;

      try{
        await ensureAnonAuth();
        await update(sessionRoot(sessionId), {
          status: "ended",
          endedAt: Date.now(),
          endedAtServer: serverTimestamp()
        });
        setStatus("Session ended. Returning to games…");
        setTimeout(()=>{ window.location.href = "games.html"; }, 400);
      }catch(e){
        console.error(e);
        setError("End failed: " + (e?.code || e?.message || "unknown"));
      }
    }

    async function setSessionCourseAndHole(courseKey, holeNum){
      if (!sessionId) return;
      try{
        await ensureAnonAuth();
        await update(sessionRoot(sessionId), {
          courseKey,
          courseName: COURSES[courseKey]?.name || "Course",
          currentHole: holeNum
        });
      }catch(e){
        console.error(e);
        setError("Update failed: " + (e?.code || e?.message || "unknown"));
      }
    }

    async function applyDelta(pid, bucket, delta){
      if (!sessionId) return;
      setError("");

      try{
        await ensureAnonAuth();
        if (!lastSnapshot) { setError("Session not loaded yet."); return; }

        const curHole = Number(lastSnapshot.currentHole || 1);
        const curCourseKey = lastSnapshot.courseKey || "southern_oaks";
        const holeNum = (Number.isFinite(curHole) && curHole >= 1 && curHole <= 18) ? curHole : 1;

        const cur = Number(lastSnapshot.scores?.[pid]?.[bucket] || 0);
        const next = Math.max(0, cur + delta);

        const updates = {};
        updates[`games/bingoBangoBongo/sessions/${sessionId}/scores/${pid}/${bucket}`] = next;

        if (delta > 0) {
          const prevCount = Number(lastSnapshot.holeAwards?.[holeNum]?.count || 0);
          const newCount = prevCount + 1;
          updates[`games/bingoBangoBongo/sessions/${sessionId}/holeAwards/${holeNum}/count`] = newCount;
          updates[`games/bingoBangoBongo/sessions/${sessionId}/holeAwards/${holeNum}/lastUpdatedAt`] = Date.now();

          if (newCount >= 3) {
            const nextHole = Math.min(18, holeNum + 1);
            updates[`games/bingoBangoBongo/sessions/${sessionId}/currentHole`] = nextHole;
          }
        }

        await update(ref(db), updates);

        const logPush = push(sessionLogRef(sessionId));
        await set(logPush, {
          createdAt: Date.now(),
          createdAtServer: serverTimestamp(),
          pid,
          playerName: (players[pid]?.name || lastSnapshot.players?.[pid]?.name || "Player"),
          bucket,
          delta: (delta > 0 ? 1 : -1),
          hole: holeNum,
          courseKey: curCourseKey
        });
      }catch(e){
        console.error(e);
        setError("Update failed: " + (e?.code || e?.message || "unknown"));
      }
    }

    function syncCourseHoleUIFromSession(){
      if (!lastSnapshot) return;

      const courseKey = lastSnapshot.courseKey || "southern_oaks";
      currentCourseKey = courseKey;

      if (els.courseSelect.value !== courseKey) els.courseSelect.value = courseKey;

      buildHoleSelect();

      const holeNum = Number(lastSnapshot.currentHole || 1);
      els.holeSelect.value = String((holeNum >= 1 && holeNum <= 18) ? holeNum : 1);

      setHoleMeta(els.holeSelect.value);

      const count = Number(lastSnapshot.holeAwards?.[holeNum]?.count || 0);
      setHoleAwardCount(count);
    }

    async function init(){
      try{
        setStatus("Signing in…");
        await ensureAnonAuth();
        setStatus("");
      }catch(e){
        console.error(e);
        setError("Auth failed. Make sure Anonymous sign-in is enabled in Firebase Auth.");
        return;
      }

      buildHoleSelect();
      setHoleMeta(1);
      setHoleAwardCount(0);

      // Watch sessions list to compute Game # mapping
      onValue(sessionsRootRef, (snap)=>{
        const all = snap.val() || {};
        gameNumMap = computeGameNumbers(all);
        setSessionLabel();
      });

      // Players
      onValue(playersRef, (snap)=>{
        players = snap.val() || {};
        if (!sessionId) renderPlayerPicker();
        if (lastSnapshot) {
          renderStickyLeaderboard(lastSnapshot.players || {}, lastSnapshot.scores || {});
          renderScoreboard(lastSnapshot.players || {}, lastSnapshot.scores || {});
        }
      });

      if (!sessionId){
        setSessionLabel();
        els.startCard.style.display = "block";
        els.bottomBar.style.display = "none";
        els.stickyLb.classList.add("sticky-hidden");
        els.bottomTitle.textContent = "No session";
        els.bottomSub.textContent = "Start a new session to score";
        return;
      }

      // Active session
      els.startCard.style.display = "none";
      els.bottomBar.style.display = "block";
      els.bottomTitle.textContent = "Session live";
      els.bottomSub.textContent = "Tap + / − to score points";
      setSessionLabel();

      onValue(sessionRoot(sessionId), (snap)=>{
        const data = snap.val();
        if (!data){
          setError("Session not found. Start a new one.");
          els.scoreGrid.innerHTML = `<div class="hint">No session loaded.</div>`;
          els.stickyLb.classList.add("sticky-hidden");
          els.bottomBar.style.display = "none";
          return;
        }
        lastSnapshot = data;

        syncCourseHoleUIFromSession();
        renderStickyLeaderboard(data.players || {}, data.scores || {});
        renderScoreboard(data.players || {}, data.scores || {});
      }, (err)=>{
        console.error(err);
        setError("Read failed: " + (err?.code || err?.message || "unknown"));
      });
    }

    // Picker
    els.pickList.addEventListener("change", (e)=>{
      const cb = e.target.closest("input[type='checkbox'][data-pick]");
      if (!cb) return;
      const pid = cb.getAttribute("data-pick");
      if (!pid) return;
      cb.checked ? selected.add(pid) : selected.delete(pid);
    });

    els.newSessionBtn.addEventListener("click", startNewSession);
    els.endSessionBtn.addEventListener("click", endSession);

    els.scoreGrid.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const pid = btn.getAttribute("data-pid");
      const bucket = btn.getAttribute("data-bucket");
      if (!pid || !bucket) return;

      if (action === "inc") applyDelta(pid, bucket, +1);
      if (action === "dec") applyDelta(pid, bucket, -1);
    });

    els.courseSelect.addEventListener("change", async ()=>{
      currentCourseKey = els.courseSelect.value || "southern_oaks";
      buildHoleSelect();
      setHoleMeta(1);

      if (sessionId && lastSnapshot) {
        await setSessionCourseAndHole(currentCourseKey, 1);
      } else {
        els.holeSelect.value = "1";
        setHoleAwardCount(0);
      }
    });

    els.holeSelect.addEventListener("change", async ()=>{
      const holeNum = Number(els.holeSelect.value || 1);
      setHoleMeta(holeNum);

      if (sessionId && lastSnapshot) {
        await setSessionCourseAndHole(currentCourseKey, holeNum);
      } else {
        setHoleAwardCount(0);
      }
    });

    init();
  </script>
</body>
</html>
