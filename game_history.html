<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTK Classic – Game History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="IMG_7296.jpg" />
  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#d1d5db; --shadow-soft:0 10px 30px rgba(15,23,42,.12);
      --good:#166534; --good-soft:#dcfce7;
      --warn:#9a3412; --warn-soft:#ffedd5;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",sans-serif;}
    html,body{-webkit-text-size-adjust:100%;background:var(--bg);color:var(--text);min-height:100%;}
    body{min-height:100vh;padding:.75rem;touch-action:manipulation;}
    @media (min-width:768px){ body{max-width:1100px;margin:0 auto;} }
    a{color:inherit;text-decoration:none;-webkit-tap-highlight-color:transparent;}
    button{-webkit-tap-highlight-color:transparent;}

    .menu-overlay{position:fixed;inset:0;display:none;z-index:1000;background:rgba(17,24,39,.08);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);}

    .site-header{display:flex;align-items:center;gap:.75rem;position:relative;}
    .site-header-left{display:flex;align-items:center;gap:.6rem;min-width:0;}
    .site-logo{height:32px;width:auto;border-radius:.45rem;object-fit:cover;background:#e5e7eb;flex-shrink:0;}
    .site-title-group{display:flex;flex-direction:column;gap:.15rem;min-width:0;}
    .site-title{font-size:1.05rem;font-weight:800;white-space:nowrap;}
    .site-subtitle{font-size:.78rem;color:var(--muted);white-space:nowrap;}

    .nav-links{margin-left:auto;display:flex;gap:.4rem;align-items:center;}
    .nav-desktop{display:flex;gap:.4rem;align-items:center;}
    .nav-btn{
      font-size:.85rem;border-radius:999px;padding:.3rem .9rem;border:1px solid var(--border);
      background:#fff;color:var(--text);white-space:nowrap;min-height:32px;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .nav-btn.secondary{background:#f9fafb;}

    .hamburger{
      display:none;font-size:1.35rem;background:#fff;border:1px solid var(--border);
      border-radius:999px;padding:.25rem .7rem;min-height:32px;cursor:pointer;line-height:1;
    }
    .hamburger-menu{
      position:absolute;top:44px;right:0;background:#fff;border:1px solid var(--border);
      border-radius:.9rem;box-shadow:var(--shadow-soft);display:none;flex-direction:column;
      min-width:220px;z-index:1001;overflow:hidden;
    }
    .hamburger-menu a{padding:.7rem .85rem;font-size:.9rem;border-top:1px solid #f3f4f6;}
    .hamburger-menu a:first-child{border-top:none;}
    .hamburger-menu a:hover{background:#f3f4f6;}
    @media (max-width:700px){ .nav-desktop{display:none;} .hamburger{display:inline-flex;align-items:center;justify-content:center;} }

    main{margin-top:.75rem;display:flex;flex-direction:column;gap:.75rem;}

    .card{
      background:var(--card);border-radius:.9rem;padding:.85rem;border:1px solid var(--border);
      box-shadow:var(--shadow-soft);
    }
    .section-title{
      font-size:.82rem;font-weight:650;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);
      border-bottom:1px dashed #e5e7eb;padding-bottom:.35rem;margin-bottom:.55rem;
    }

    .controls{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-bottom:.6rem;}
    .controls input,.controls select{
      padding:.5rem .6rem;border-radius:.65rem;border:1px solid var(--border);background:#fff;font-size:.9rem;min-height:42px;
    }
    .controls input{flex:1;min-width:240px;}
    .controls select{width:220px;}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:.55rem;}
    .session-card{
      border:1px solid #e5e7eb;background:#fff;border-radius:.85rem;padding:.75rem;
      transition:transform .08s ease, box-shadow .08s ease, border-color .08s ease;
    }
    .session-card:hover{transform:translateY(-1px);box-shadow:0 3px 10px rgba(15,23,42,.12);border-color:#cbd5f5;}
    .row{display:flex;justify-content:space-between;gap:.6rem;align-items:baseline;flex-wrap:wrap;}
    .game-title{font-weight:950;font-size:1.05rem;}
    .meta{font-size:.82rem;color:var(--muted);margin-top:.25rem;line-height:1.2rem;}
    .pill{
      display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .6rem;border-radius:999px;
      border:1px solid #e5e7eb;background:#f9fafb;font-size:.78rem;color:#374151;white-space:nowrap;
    }
    .pill.live{border-color:#fed7aa;background:var(--warn-soft);color:var(--warn);}
    .pill.ended{border-color:#bbf7d0;background:var(--good-soft);color:var(--good);}
    .btnlink{
      display:inline-flex;align-items:center;justify-content:center;gap:.25rem;
      border-radius:999px;border:1px solid var(--border);background:#f9fafb;padding:.4rem .75rem;
      font-size:.88rem;font-weight:750;min-height:38px;margin-top:.55rem;width:fit-content;
    }
    .lb{margin-top:.55rem;border-top:1px dashed #e5e7eb;padding-top:.55rem;display:flex;flex-direction:column;gap:.25rem;}
    .lb-item{display:flex;justify-content:space-between;gap:.6rem;font-size:.88rem;align-items:baseline;}
    .lb-name{font-weight:850;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .lb-score{font-weight:950;white-space:nowrap;}
    .empty{color:var(--muted);text-align:center;padding:.8rem .5rem;font-size:.9rem;}
    .err{
      margin-top:.6rem;font-size:.85rem;color:#b91c1c;background:#fef2f2;border:1px solid #fecaca;
      padding:.5rem .65rem;border-radius:.75rem;display:none;
    }
  </style>
</head>
<body>
  <div id="menuOverlay" class="menu-overlay"></div>

  <header class="site-header">
    <div class="site-header-left">
      <img src="IMG_7296.jpg" alt="FTK Classic logo" class="site-logo" />
      <div class="site-title-group">
        <div class="site-title">FTK Classic</div>
        <div class="site-subtitle">Game history</div>
      </div>
    </div>

    <nav class="nav-links">
      <div class="nav-desktop">
        <a href="index.html" class="nav-btn secondary">Home</a>
        <a href="spectator.html" class="nav-btn secondary">Scores</a>
        <a href="games.html" class="nav-btn secondary">Games</a>
      </div>

      <button id="hamburgerBtn" class="hamburger" aria-label="Menu" aria-expanded="false">☰</button>

      <div id="hamburgerMenu" class="hamburger-menu" aria-label="Navigation Menu">
        <a href="index.html">Home</a>
        <a href="spectator.html">Scores</a>
        <a href="games.html">Games</a>
      </div>
    </nav>
  </header>

  <main>
    <section class="card">
      <div class="section-title">Bingo Bango Bongo sessions</div>

      <div class="controls">
        <input id="search" type="text" placeholder="Search by game # or player name…" />
        <select id="filter">
          <option value="all">Show: All</option>
          <option value="live">Show: Live</option>
          <option value="ended">Show: Ended</option>
        </select>
      </div>

      <div id="grid" class="grid">
        <div class="empty">Loading…</div>
      </div>

      <div id="error" class="err"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5fk91DPgPBkJ3_xGnNntD3PQbi5Ib3kg",
      authDomain: "ftkclassicdb.firebaseapp.com",
      databaseURL: "https://ftkclassicdb-default-rtdb.firebaseio.com",
      projectId: "ftkclassicdb",
      storageBucket: "ftkclassicdb.firebasestorage.app",
      messagingSenderId: "963469808092",
      appId: "1:963469808092:web:e6e789ce20ef46404b3f19"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    async function ensureAnonAuth(){
      return new Promise((resolve,reject)=>{
        const unsub = onAuthStateChanged(auth, async (user)=>{
          try{
            if(user){ unsub(); return resolve(user); }
            const cred = await signInAnonymously(auth);
            unsub();
            resolve(cred.user);
          }catch(e){
            unsub(); reject(e);
          }
        });
      });
    }

    const els = {
      grid: document.getElementById("grid"),
      search: document.getElementById("search"),
      filter: document.getElementById("filter"),
      error: document.getElementById("error"),
      hamburgerBtn: document.getElementById("hamburgerBtn"),
      hamburgerMenu: document.getElementById("hamburgerMenu"),
      menuOverlay: document.getElementById("menuOverlay")
    };

    function setError(msg){
      els.error.textContent = msg || "";
      els.error.style.display = msg ? "block" : "none";
    }
    function safeText(s){
      return String(s||"").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }
    function normalize(s){ return String(s||"").trim().toLowerCase(); }
    function fmtDate(ts){
      if(!ts) return "—";
      try{
        return new Date(ts).toLocaleString([], { month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" });
      }catch{ return "—"; }
    }

    // Hamburger
    function openMenu(){
      els.hamburgerMenu.style.display="flex";
      els.menuOverlay.style.display="block";
      els.hamburgerBtn.setAttribute("aria-expanded","true");
    }
    function closeMenu(){
      els.hamburgerMenu.style.display="none";
      els.menuOverlay.style.display="none";
      els.hamburgerBtn.setAttribute("aria-expanded","false");
    }
    els.hamburgerBtn?.addEventListener("click",(e)=>{
      e.stopPropagation();
      (els.hamburgerMenu.style.display==="flex") ? closeMenu() : openMenu();
    });
    els.menuOverlay?.addEventListener("click", closeMenu);
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeMenu(); });

    let sessions = {};

    function computeLeaderboardTop3(sess){
      const players = sess?.players || {};
      const scores = sess?.scores || {};
      const rows = Object.keys(players).map(pid=>{
        const name = players[pid]?.name || "Player";
        const s = scores[pid] || {};
        const total = Number(s.bingo||0) + Number(s.bango||0) + Number(s.bongo||0);
        return { name, total };
      });

      rows.sort((a,b)=> b.total - a.total || a.name.localeCompare(b.name));
      return rows.slice(0,3);
    }

    function computeGameNumbers(allSessions){
      // oldest -> newest = Game 1 -> Game N
      const arr = Object.entries(allSessions || {}).map(([sid, sess]) => ({
        sid,
        createdAt: Number(sess?.createdAt || 0)
      }));
      arr.sort((a,b) => (a.createdAt - b.createdAt) || a.sid.localeCompare(b.sid));

      const map = {};
      arr.forEach((x, i) => { map[x.sid] = i + 1; });
      return map;
    }

    function buildModel(){
      const q = normalize(els.search.value);
      const f = els.filter.value;

      const gameNumMap = computeGameNumbers(sessions);

      const out = Object.entries(sessions || {}).map(([sid, sess])=>{
        const status = (sess?.status || "live");
        const playersObj = sess?.players || {};
        const names = Object.values(playersObj).map(p=>p?.name||"").filter(Boolean);
        const createdAt = Number(sess?.createdAt || 0);
        const top3 = computeLeaderboardTop3(sess);
        const gameNum = gameNumMap[sid] || 0;
        return { sid, status, names, createdAt, top3, gameNum };
      });

      let filtered = out;

      if (f === "live") filtered = filtered.filter(x => x.status !== "ended");
      if (f === "ended") filtered = filtered.filter(x => x.status === "ended");

      if (q){
        filtered = filtered.filter(x=>{
          const gameLabel = `game ${x.gameNum}`;
          if (normalize(gameLabel).includes(q)) return true;
          return x.names.some(n => normalize(n).includes(q));
        });
      }

      // newest first in list
      filtered.sort((a,b)=> (Number(b.createdAt||0) - Number(a.createdAt||0)));
      return filtered;
    }

    function render(){
      const model = buildModel();
      if (!model.length){
        els.grid.innerHTML = `<div class="empty">No sessions found.</div>`;
        return;
      }

      els.grid.innerHTML = model.map(x=>{
        const pillClass = (x.status === "ended") ? "pill ended" : "pill live";
        const pillText = (x.status === "ended") ? "Ended" : "Live";
        const playerCount = x.names.length;

        const topHtml = x.top3.length
          ? `<div class="lb">
              ${x.top3.map((r,i)=>`
                <div class="lb-item">
                  <div class="lb-name">${i+1}. ${safeText(r.name)}</div>
                  <div class="lb-score">${safeText(r.total)}</div>
                </div>
              `).join("")}
            </div>`
          : `<div class="meta">No scores yet.</div>`;

        return `
          <div class="session-card">
            <div class="row">
              <div class="game-title">Game ${safeText(x.gameNum)}</div>
              <div class="${pillClass}">${pillText}</div>
            </div>
            <div class="meta">
              <div><strong>${playerCount}</strong> player${playerCount===1?"":"s"}</div>
              <div>Created: ${safeText(fmtDate(x.createdAt))}</div>
            </div>

            <a class="btnlink" href="bingo_bango_bongo.html?session=${encodeURIComponent(x.sid)}">Open →</a>
            ${topHtml}
          </div>
        `;
      }).join("");
    }

    els.search.addEventListener("input", render);
    els.filter.addEventListener("change", render);

    async function init(){
      try{
        await ensureAnonAuth();
      }catch(e){
        console.error(e);
        setError("Auth failed. Make sure Anonymous sign-in is enabled.");
        return;
      }

      const sessionsRef = ref(db, "games/bingoBangoBongo/sessions");
      onValue(sessionsRef, (snap)=>{
        sessions = snap.val() || {};
        render();
      }, (err)=>{
        console.error(err);
        setError("Read failed: " + (err?.code || err?.message || "unknown"));
      });
    }

    init();
  </script>
</body>
</html>
