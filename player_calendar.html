<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTK Classic – Player Availability</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="IMG_7296.jpg" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #d1d5db;
      --accent: #1d4ed8;
    }
    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      color: var(--text);
    }
    header {
      background: white;
      padding: 14px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
    }
    .calendar {
      max-width: 900px;
      margin: 20px auto;
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,.1);
    }
    .cal-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .month-title {
      font-weight: 800;
      font-size: 18px;
      letter-spacing: -0.01em;
    }
    .nav-btns {
      display: flex;
      gap: 8px;
    }
    .btn {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
    }
    .btn:active { transform: translateY(1px); }
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .weekday {
      text-align: center;
      padding: 6px 0;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .day {
      padding: 12px 6px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      user-select: none;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    .day.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .day.muted {
      opacity: .35;
      cursor: default;
      font-weight: 600;
    }
    .note {
      max-width: 900px;
      margin: 10px auto 0 auto;
      color: var(--muted);
      font-size: 13px;
      padding: 0 12px;
      text-align: center;
    }
  </style>
</head>
<body>

<header>Pick the days you’re available to golf</header>

<div class="calendar">
  <div class="cal-top">
    <div class="month-title" id="monthTitle">Loading…</div>
    <div class="nav-btns">
      <button class="btn" id="prevBtn">‹</button>
      <button class="btn" id="todayBtn">Today</button>
      <button class="btn" id="nextBtn">›</button>
    </div>
  </div>

  <div class="weekdays" id="weekdayRow">
    <div class="weekday">Sun</div>
    <div class="weekday">Mon</div>
    <div class="weekday">Tue</div>
    <div class="weekday">Wed</div>
    <div class="weekday">Thu</div>
    <div class="weekday">Fri</div>
    <div class="weekday">Sat</div>
  </div>

  <div class="grid" id="calendarGrid"></div>
</div>

<div class="note" id="statusNote">Loading…</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD5fk91DPgPBkJ3_xGnNntD3PQbi5Ib3kg",
    authDomain: "ftkclassicdb.firebaseapp.com",
    databaseURL: "https://ftkclassicdb-default-rtdb.firebaseio.com",
    projectId: "ftkclassicdb",
    storageBucket: "ftkclassicdb-firebasestorage.app",
    messagingSenderId: "963469808092",
    appId: "1:963469808092:web:e6e789ce20ef46404b3f19"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const params = new URLSearchParams(window.location.search);
  const playerId = params.get("player");

  const statusNote = document.getElementById("statusNote");
  const grid = document.getElementById("calendarGrid");
  const monthTitle = document.getElementById("monthTitle");

  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const todayBtn = document.getElementById("todayBtn");

  if (!playerId) {
    alert("Missing player ID");
    location.href = "index.html";
  }

  // null-auth (anonymous)
  signInAnonymously(auth).catch((e) => {
    console.error("Anonymous auth failed:", e);
    statusNote.textContent = "Auth error. Check Firebase Auth settings (Anonymous) and rules.";
  });

  let authed = false;
  let availData = {};
  let viewYear, viewMonth; // month 0-11

  const monthNames = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];

  const availRef = ref(db, `availability/${playerId}`);

  onAuthStateChanged(auth, (user) => {
    if (!user) return;
    authed = true;
    statusNote.textContent = "Tap a day to toggle availability.";

    const now = new Date();
    viewYear = now.getFullYear();
    viewMonth = now.getMonth();

    // Live sync availability
    onValue(availRef, (snap) => {
      availData = snap.val() || {};
      renderMonth();
    }, (err) => {
      console.error("DB read error:", err);
      statusNote.textContent = "Database error. Check rules for availability/* (read/write) and auth.";
    });
  });

  prevBtn.onclick = () => {
    if (viewMonth === 0) { viewMonth = 11; viewYear--; }
    else viewMonth--;
    renderMonth();
  };

  nextBtn.onclick = () => {
    if (viewMonth === 11) { viewMonth = 0; viewYear++; }
    else viewMonth++;
    renderMonth();
  };

  todayBtn.onclick = () => {
    const now = new Date();
    viewYear = now.getFullYear();
    viewMonth = now.getMonth();
    renderMonth();
  };

  function keyFor(y, m0, d) {
    return `${y}-${String(m0 + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
  }

  function renderMonth() {
    if (!authed) return;

    monthTitle.textContent = `${monthNames[viewMonth]} ${viewYear}`;
    grid.innerHTML = "";

    const firstDow = new Date(viewYear, viewMonth, 1).getDay(); // 0 Sun
    const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();

    // Leading blanks
    for (let i = 0; i < firstDow; i++) {
      const blank = document.createElement("div");
      blank.className = "day muted";
      blank.textContent = "";
      blank.style.border = "1px solid transparent";
      blank.style.background = "transparent";
      grid.appendChild(blank);
    }

    // Days
    for (let d = 1; d <= daysInMonth; d++) {
      const dateKey = keyFor(viewYear, viewMonth, d);
      const div = document.createElement("div");
      div.className = "day";
      div.textContent = d;

      if (availData[dateKey]) div.classList.add("active");

      div.onclick = () => {
        if (availData[dateKey]) {
          remove(ref(db, `availability/${playerId}/${dateKey}`));
        } else {
          set(ref(db, `availability/${playerId}/${dateKey}`), true);
        }
      };

      grid.appendChild(div);
    }
  }
</script>

</body>
</html>
