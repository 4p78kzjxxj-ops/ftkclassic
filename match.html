// returns downloadURL on success
async function captureAndUploadPhoto(matchId, holeNumber, options = {}) {
  try {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    // back camera hint (not selfie)
    input.capture = "environment";

    const file = await new Promise((resolve, reject) => {
      input.onchange = () => resolve(input.files[0]);
      input.onerror = reject;
      input.click();
    });

    if (!file) return null;

    const imageId = `${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
    const storagePath = `matchPhotos/${matchId}/${imageId}`;
    const storageRef = sRef(storage, storagePath);
    await uploadBytes(storageRef, file);
    const downloadURL = await getDownloadURL(storageRef);

    const photosRef = ref(db, "photos");
    const photoMeta = {
      matchId,
      holeNumber: holeNumber || null,
      createdAt: Date.now(),
      url: downloadURL,
      type: options.group ? "group" : "regular",
    };
    await set(push(photosRef), photoMeta);

    if (options.group) {
      await update(ref(db, `matches/${matchId}`), {
        groupPhotoUrl: downloadURL,
        groupPhotoTakenAt: Date.now(),
      });
    }

    return downloadURL;
  } catch (err) {
    console.error("Photo upload failed", err);
    alert("Photo upload failed: " + (err && err.message ? err.message : "Please try again."));
    return null;
  }
}
