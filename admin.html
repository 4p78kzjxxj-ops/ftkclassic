<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTK Classic ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="IMG_7296.jpg" />
  <style>
    :root {
      --red: #b91c1c;
      --blue: #1d4ed8;
      --bg: #f3f4f6;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #d1d5db;
      --danger: #b91c1c;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 0.75rem;
    }

    @media (min-width: 768px) {
      body {
        max-width: 1000px;
        margin: 0 auto;
      }
    }

    .site-header {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.75rem;
    }

    .site-header-left {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .site-logo {
      height: 32px;
      width: auto;
      border-radius: 0.45rem;
      object-fit: cover;
      background: #e5e7eb;
    }

    .site-title {
      font-size: 1rem;
      font-weight: 700;
    }

    .site-subtitle {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .viewer-count {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.15rem;
    }

    /* HAMBURGER MENU */
    .menu-wrap {
      margin-left: auto;
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .hamburger-btn {
      height: 36px;
      width: 40px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .hamburger-btn:active { transform: scale(0.98); }

    .hamburger-icon {
      width: 18px;
      height: 12px;
      position: relative;
    }
    .hamburger-icon span {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: #111827;
      border-radius: 999px;
    }
    .hamburger-icon span:nth-child(1) { top: 0; }
    .hamburger-icon span:nth-child(2) { top: 5px; }
    .hamburger-icon span:nth-child(3) { top: 10px; }

    .menu-panel {
      position: absolute;
      top: 44px;
      right: 0;
      width: 260px;
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 0.9rem;
      box-shadow: 0 12px 28px rgba(0,0,0,0.18);
      display: none;
      overflow: hidden;
      z-index: 9998;
    }

    .menu-panel.open { display: block; }

    .menu-section {
      padding: 0.45rem 0.45rem 0.35rem;
      border-bottom: 1px solid #eef2f7;
      background: #ffffff;
    }

    .menu-section:last-child { border-bottom: none; }

    .menu-section-title {
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0.2rem 0.3rem 0.35rem;
    }

    .menu-item {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.55rem 0.6rem;
      border-radius: 0.7rem;
      border: 1px solid transparent;
      background: #ffffff;
      text-decoration: none;
      color: var(--text);
      font-size: 0.85rem;
      cursor: pointer;
      text-align: left;
    }

    .menu-item:hover {
      background: #f3f4f6;
      border-color: #e5e7eb;
    }

    .menu-item.danger {
      color: #991b1b;
    }

    .menu-item.danger:hover {
      background: #fef2f2;
      border-color: #fecaca;
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding-bottom: 2rem;
    }

    .card {
      background: var(--card);
      border-radius: 0.9rem;
      padding: 0.75rem;
      border: 1px solid var(--border);
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.4rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.25rem;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 0;
    }

    .field label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .field input,
    .field select {
      padding: 0.35rem 0.4rem;
      border-radius: 0.55rem;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
      background: #ffffff;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      padding: 0.35rem 0.8rem;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .btn-primary {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    .btn-danger {
      background: #fef2f2;
      color: var(--danger);
      border-color: #fecaca;
    }

    .btn-sm {
      padding: 0.2rem 0.5rem;
      font-size: 0.75rem;
    }

    .status-text {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.2rem;
    }

    .two-col {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 0.6rem;
    }

    @media (max-width: 700px) {
      .two-col {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .team-block {
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
    }

    .team-block-title {
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .team-block-title.red { color: var(--red); }
    .team-block-title.blue { color: var(--blue); }

    .players-list {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 0.2rem;
    }

    .player-row {
      display: grid;
      grid-template-columns: minmax(0,2fr) minmax(0,1fr) auto;
      gap: 0.3rem;
      align-items: center;
      font-size: 0.78rem;
    }

    .player-row input,
    .player-row select {
      font-size: 0.76rem;
      padding: 0.25rem 0.3rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
    }

    .player-name-cell {
      display: flex;
      gap: 0.25rem;
      align-items: center;
    }

    .player-team-pill {
      font-size: 0.65rem;
      border-radius: 999px;
      padding: 0.05rem 0.4rem;
      background: #f3f4f6;
      color: #4b5563;
    }

    .player-team-pill.red { background: #fee2e2; color: #7f1d1d; }
    .player-team-pill.blue { background: #dbeafe; color: #1e3a8a; }

    .matches-grid {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .match-row {
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
      background: #ffffff;
    }

    .match-row-header {
      display: flex;
      justify-content: space-between;
      gap: 0.3rem;
      margin-bottom: 0.35rem;
      font-size: 0.8rem;
    }

    .match-row-title {
      font-weight: 600;
    }

    .match-row-sub {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .match-row-body {
      display: grid;
      grid-template-columns: minmax(0,1fr) auto minmax(0,1fr);
      gap: 0.4rem;
      align-items: center;
    }

    .match-side {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .match-side-label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .match-side-label.red { color: var(--red); }
    .match-side-label.blue { color: var(--blue); }

    .match-side select {
      width: 100%;
      padding: 0.3rem 0.35rem;
      border-radius: 0.55rem;
      border: 1px solid #d1d5db;
      font-size: 0.78rem;
      background: #ffffff;
    }

    .vs-label {
      font-size: 0.78rem;
      font-weight: 600;
      color: #4b5563;
      text-align: center;
    }

    .danger-note {
      font-size: 0.74rem;
      color: #991b1b;
      margin-top: 0.2rem;
    }

    /* AUTH MODAL */
    #authOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #authBox {
      background: #ffffff;
      padding: 1.2rem;
      border-radius: 0.9rem;
      width: 85%;
      max-width: 360px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.3);
      text-align: center;
      animation: fadeIn 0.2s ease-out;
    }

    #authTitle {
      font-size: 1rem;
      margin-bottom: 0.4rem;
    }

    #authMessage {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.7rem;
    }

    #authPasswordInput {
      width: 100%;
      padding: 0.6rem;
      font-size: 0.9rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      margin-bottom: 0.6rem;
      text-align: center;
    }

    #authError {
      font-size: 0.78rem;
      color: var(--danger);
      min-height: 1em;
      margin-bottom: 0.35rem;
    }

    #authSubmitBtn,
    #authCancelBtn {
      width: 100%;
      padding: 0.6rem;
      border-radius: 999px;
      font-size: 0.9rem;
      margin-bottom: 0.35rem;
      cursor: pointer;
    }

    #authSubmitBtn {
      background: #111827;
      color: #f9fafb;
      border: none;
      font-weight: 600;
    }

    #authCancelBtn {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      color: #374151;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="site-header-left">
      <img src="IMG_7296.jpg" alt="FTK Classic logo" class="site-logo" />
      <div>
        <div class="site-title">FTK Classic</div>
        <div class="site-subtitle">Admin control panel</div>
        <div id="viewerCount" class="viewer-count">Viewing now: 0 admins</div>
      </div>
    </div>

    <div class="menu-wrap">
      <button id="hamburgerBtn" class="hamburger-btn" type="button" aria-label="Open menu">
        <div class="hamburger-icon" aria-hidden="true">
          <span></span><span></span><span></span>
        </div>
      </button>

      <div id="menuPanel" class="menu-panel" role="menu" aria-label="Admin menu">
        <div class="menu-section">
          <div class="menu-section-title">Navigate</div>
          <a class="menu-item" href="index.html">Home</a>
          <a class="menu-item" href="spectator.html">Scores</a>
          <a class="menu-item" href="chat.html">Chat</a>
          <a class="menu-item" href="tournament_feed.html">Feed</a>
        </div>

        <div class="menu-section">
          <div class="menu-section-title">Actions</div>
          <button id="menuClearFeedBtn" class="menu-item danger" type="button">Clear feed</button>
          <button id="menuClearChatBtn" class="menu-item danger" type="button">Clear chat</button>
          <button id="menuDeletePhotosBtn" class="menu-item danger" type="button">Delete photos</button>
          <button id="menuResetScoresBtn" class="menu-item danger" type="button">Reset match scores</button>
        </div>

        <div class="menu-section">
          <div class="menu-section-title">Fall 2025</div>
          <button id="menuUploadFall2025Btn" class="menu-item" type="button">Upload photos from Fall 2025 Classic</button>
        </div>
      </div>
    </div>
  </header>

  <!-- AUTH MODAL OVERLAY -->
  <div id="authOverlay">
    <div id="authBox">
      <h2 id="authTitle">Admin access</h2>
      <p id="authMessage">Enter the admin password to manage players, teams, matches and photos.</p>
      <input
        id="authPasswordInput"
        type="password"
        placeholder="Admin password"
        autocomplete="off"
      />
      <div id="authError"></div>
      <button id="authSubmitBtn">Continue</button>
      <button id="authCancelBtn">Back to home</button>
    </div>
  </div>

  <main>
    <!-- TEAM SETTINGS -->
    <section class="card">
      <div class="section-title">Teams & settings</div>
      <div class="form-row">
        <div class="field">
          <label for="redTeamName">Red team name</label>
          <input id="redTeamName" type="text" placeholder="Red Team" />
        </div>
        <div class="field">
          <label for="blueTeamName">Blue team name</label>
          <input id="blueTeamName" type="text" placeholder="Blue Team" />
        </div>
        <div class="field" style="align-self:flex-end;">
          <button id="saveTeamsBtn" type="button" class="btn btn-primary">
            Save team names
          </button>
        </div>
      </div>
      <div id="teamsStatus" class="status-text"></div>
    </section>

    <!-- PLAYERS -->
    <section class="card">
      <div class="section-title">Players & handicaps</div>
      <div class="form-row">
        <div class="field" style="flex:2;">
          <label for="newPlayerName">Player name</label>
          <input id="newPlayerName" type="text" placeholder="First Last" />
        </div>
        <div class="field" style="width:110px;">
          <label for="newPlayerTeam">Team</label>
          <select id="newPlayerTeam">
            <option value="red">Red</option>
            <option value="blue">Blue</option>
          </select>
        </div>
        <div class="field" style="width:110px;">
          <label for="newPlayerHcp">Handicap</label>
          <input id="newPlayerHcp" type="number" step="0.1" placeholder="0.0" />
        </div>
        <div class="field" style="align-self:flex-end;">
          <button id="addPlayerBtn" type="button" class="btn btn-primary">
            Add player
          </button>
        </div>
      </div>
      <div class="two-col">
        <div class="team-block">
          <div class="team-block-title red" id="redTeamLabel">Red team</div>
          <div id="redPlayersList" class="players-list"></div>
        </div>
        <div class="team-block">
          <div class="team-block-title blue" id="blueTeamLabel">Blue team</div>
          <div id="bluePlayersList" class="players-list"></div>
        </div>
      </div>
      <div id="playersStatus" class="status-text"></div>
    </section>

    <!-- MATCHES -->
    <section class="card">
      <div class="section-title">Matches ‚Äì Front 9 (1‚Äì8)</div>
      <div id="frontMatchesContainer" class="matches-grid"></div>
    </section>

    <section class="card">
      <div class="section-title">Matches ‚Äì Back 9 (9‚Äì16)</div>
      <div id="backMatchesContainer" class="matches-grid"></div>
    </section>

    <!-- GLOBAL ADMIN TOOLS -->
    <section class="card">
      <div class="section-title">Admin tools</div>
      <button id="resetScoresBtn" type="button" class="btn">
        Reset ALL match scores (holes)
      </button>
      <div class="status-text">
        This will set all 18 holes for all 16 matches back to "no result".
      </div>

      <hr style="margin:0.75rem 0; border:none; border-top:1px dashed #e5e7eb;" />

      <button id="deletePhotosBtn" type="button" class="btn btn-danger">
        üóëÔ∏è Delete ALL photos
      </button>
      <div class="danger-note">
        This permanently deletes all photos from Storage and the photos node in the database.
      </div>

      <div id="adminToolsStatus" class="status-text"></div>
    </section>
  </main>

  <!-- Hidden file input for Fall 2025 upload -->
  <input id="fall2025FileInput" type="file" accept="image/*" multiple style="display:none;" />

  <!-- AUTH / PASSWORD MODAL LOGIC -->
  <script>
    (function () {
      const ADMIN_PASSWORD = "admin123"; // change here if you want a different password
      const ADMIN_CODE = "3618"; // admin code for destructive actions

      const overlay = document.getElementById("authOverlay");
      const titleEl = document.getElementById("authTitle");
      const msgEl = document.getElementById("authMessage");
      const pwdInput = document.getElementById("authPasswordInput");
      const submitBtn = document.getElementById("authSubmitBtn");
      const cancelBtn = document.getElementById("authCancelBtn");
      const errorEl = document.getElementById("authError");

      let currentAction = null;
      let redirectHomeOnCancel = false;
      let currentValidator = null; // function(value) => boolean
      let restoreInputType = "password";
      let restorePlaceholder = "Admin password";

      function showOverlay(options) {
        const {
          title = "Admin access",
          message = "Enter the admin password.",
          placeholder = "Admin password",
          inputType = "password",
          validator = null,
          onSuccess = null,
          redirectHome = false,
        } = options || {};

        currentAction = typeof onSuccess === "function" ? onSuccess : null;
        redirectHomeOnCancel = !!redirectHome;
        currentValidator = typeof validator === "function" ? validator : null;

        titleEl.textContent = title;
        msgEl.textContent = message;
        errorEl.textContent = "";
        pwdInput.value = "";

        restoreInputType = pwdInput.type;
        restorePlaceholder = pwdInput.placeholder;

        pwdInput.type = inputType;
        pwdInput.placeholder = placeholder;

        overlay.style.display = "flex";
        setTimeout(() => pwdInput.focus(), 50);
      }

      function hideOverlay() {
        overlay.style.display = "none";
        pwdInput.type = restoreInputType || "password";
        pwdInput.placeholder = restorePlaceholder || "Admin password";
        currentValidator = null;
      }

      function handleSubmit() {
        const value = (pwdInput.value || "").trim();
        if (!value) {
          errorEl.textContent = "Please enter the required value.";
          return;
        }

        const ok = currentValidator ? currentValidator(value) : (value === ADMIN_PASSWORD);

        if (ok) {
          const action = currentAction;
          currentAction = null;
          errorEl.textContent = "";

          if (action) {
            action();
          } else {
            hideOverlay();
          }
        } else {
          errorEl.textContent = "Incorrect. Try again.";
        }
      }

      function handleCancel() {
        if (redirectHomeOnCancel) {
          window.location.href = "index.html";
        } else {
          hideOverlay();
        }
      }

      submitBtn.addEventListener("click", handleSubmit);
      cancelBtn.addEventListener("click", handleCancel);
      pwdInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          handleSubmit();
        }
      });

      // Expose helpers
      window.requireAdminPassword = function (onSuccess, options) {
        showOverlay({
          title: options?.title || "Admin confirmation",
          message: options?.message || "Re-enter the admin password to continue.",
          placeholder: "Admin password",
          inputType: "password",
          validator: (v) => v === ADMIN_PASSWORD,
          onSuccess: function () {
            hideOverlay();
            if (typeof onSuccess === "function") onSuccess();
          },
          redirectHome: false,
        });
      };

      window.requireAdminCode = function (onSuccess, options) {
        showOverlay({
          title: options?.title || "Admin code required",
          message: options?.message || "Enter the admin code to continue.",
          placeholder: "Admin code",
          inputType: "text",
          validator: (v) => v === ADMIN_CODE,
          onSuccess: function () {
            hideOverlay();
            if (typeof onSuccess === "function") onSuccess();
          },
          redirectHome: false,
        });
      };

      // Initial gate: only once per tab
      window.addEventListener("load", () => {
        const already = sessionStorage.getItem("ftkAdminAuthorized") === "true";
        if (!already) {
          showOverlay({
            title: "Admin access",
            message: "Enter the admin password to manage players, teams, matches and photos.",
            placeholder: "Admin password",
            inputType: "password",
            validator: (v) => v === ADMIN_PASSWORD,
            onSuccess: function () {
              sessionStorage.setItem("ftkAdminAuthorized", "true");
              hideOverlay();
            },
            redirectHome: true,
          });
        }
      });
    })();
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
      update,
      push,
      serverTimestamp,
      onDisconnect,
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    import {
      getStorage,
      ref as storageRef,
      listAll,
      deleteObject,
      uploadBytes,
      getDownloadURL,
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    import {
      getAuth,
      signInAnonymously,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5fk91DPgPBkJ3_xGnNntD3PQbi5Ib3kg",
      authDomain: "ftkclassicdb.firebaseapp.com",
      databaseURL: "https://ftkclassicdb-default-rtdb.firebaseio.com",
      projectId: "ftkclassicdb",
      storageBucket: "ftkclassicdb.firebasestorage.app",
      messagingSenderId: "963469808092",
      appId: "1:963469808092:web:e6e789ce20ef46404b3f19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    // Anonymous auth for secured DB rules
    signInAnonymously(auth).catch((err) => {
      console.error("Admin auth failed:", err);
    });

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        console.warn("Admin page: no Firebase user signed in.");
      }
    });

    const settingsRef = ref(db, "settings");
    const playersRef = ref(db, "players");
    const matchesRef = ref(db, "matches");

    // DOM
    const viewerCountEl = document.getElementById("viewerCount");

    const redTeamNameInput = document.getElementById("redTeamName");
    const blueTeamNameInput = document.getElementById("blueTeamName");
    const saveTeamsBtn = document.getElementById("saveTeamsBtn");
    const teamsStatusEl = document.getElementById("teamsStatus");

    const newPlayerNameInput = document.getElementById("newPlayerName");
    const newPlayerTeamSelect = document.getElementById("newPlayerTeam");
    const newPlayerHcpInput = document.getElementById("newPlayerHcp");
    const addPlayerBtn = document.getElementById("addPlayerBtn");
    const redPlayersList = document.getElementById("redPlayersList");
    const bluePlayersList = document.getElementById("bluePlayersList");
    const playersStatusEl = document.getElementById("playersStatus");
    const redTeamLabel = document.getElementById("redTeamLabel");
    const blueTeamLabel = document.getElementById("blueTeamLabel");

    const frontMatchesContainer = document.getElementById("frontMatchesContainer");
    const backMatchesContainer = document.getElementById("backMatchesContainer");

    const resetScoresBtn = document.getElementById("resetScoresBtn");
    const deletePhotosBtn = document.getElementById("deletePhotosBtn");
    const adminToolsStatus = document.getElementById("adminToolsStatus");

    const hamburgerBtn = document.getElementById("hamburgerBtn");
    const menuPanel = document.getElementById("menuPanel");

    const menuClearFeedBtn = document.getElementById("menuClearFeedBtn");
    const menuClearChatBtn = document.getElementById("menuClearChatBtn");
    const menuDeletePhotosBtn = document.getElementById("menuDeletePhotosBtn");
    const menuResetScoresBtn = document.getElementById("menuResetScoresBtn");
    const menuUploadFall2025Btn = document.getElementById("menuUploadFall2025Btn");
    const fall2025FileInput = document.getElementById("fall2025FileInput");

    let settings = {};
    let players = {};
    let matches = {};

    // Menu logic
    function closeMenu() {
      menuPanel.classList.remove("open");
    }

    function toggleMenu() {
      menuPanel.classList.toggle("open");
    }

    hamburgerBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMenu();
    });

    document.addEventListener("click", (e) => {
      if (!menuPanel.classList.contains("open")) return;
      const inside = menuPanel.contains(e.target) || hamburgerBtn.contains(e.target);
      if (!inside) closeMenu();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeMenu();
    });

    // Presence
    function setupPresence(pageKey) {
      const connectionsRef = ref(db, `presence/${pageKey}`);
      const connectedRef = ref(db, ".info/connected");

      onValue(connectedRef, (snap) => {
        if (snap.val() === false) return;
        const conRef = push(connectionsRef);
        onDisconnect(conRef).remove().catch(() => {});
        set(conRef, { connectedAt: serverTimestamp() }).catch(() => {});
      });

      onValue(
        connectionsRef,
        (snap) => {
          const val = snap.val();
          const count = val ? Object.keys(val).length : 0;
          viewerCountEl.textContent =
            count === 1 ? "Viewing now: 1 admin" : `Viewing now: ${count} admins`;
        },
        () => {
          viewerCountEl.textContent = "Viewing now: 0 admins";
        }
      );
    }

    setupPresence("admin_main");

    // Helpers
    function getTeamNames() {
      const t = settings.teamNames || {};
      return { red: t.red || "Red", blue: t.blue || "Blue" };
    }

    function getLastName(fullName) {
      if (!fullName) return "";
      const parts = fullName.trim().split(/\s+/);
      return parts[parts.length - 1];
    }

    function computeUsedPlayers() {
      const usedFront = new Set();
      const usedBack = new Set();

      Object.entries(matches || {}).forEach(([mid, m]) => {
        const idNum = Number(mid);
        const type = m.type || (idNum <= 8 ? "front" : "back");
        const all = [
          ...(m.red?.players || []),
          ...(m.blue?.players || []),
        ].filter(Boolean);

        if (type === "front") {
          all.forEach((pid) => usedFront.add(pid));
        } else {
          all.forEach((pid) => usedBack.add(pid));
        }
      });

      return { usedFront, usedBack };
    }

    // Settings
    function renderSettings() {
      const { red, blue } = getTeamNames();
      if (!redTeamNameInput.value) redTeamNameInput.value = red;
      if (!blueTeamNameInput.value) blueTeamNameInput.value = blue;
      redTeamLabel.textContent = red + " team";
      blueTeamLabel.textContent = blue + " team";
    }

    saveTeamsBtn.addEventListener("click", async () => {
      const red = redTeamNameInput.value.trim() || "Red";
      const blue = blueTeamNameInput.value.trim() || "Blue";
      try {
        await update(settingsRef, {
          teamNames: { red, blue },
        });
        teamsStatusEl.textContent = "Team names saved.";
        setTimeout(() => (teamsStatusEl.textContent = ""), 3000);
      } catch (err) {
        console.error(err);
        teamsStatusEl.textContent = "Failed to save team names.";
      }
    });

    // Players
    function renderPlayers() {
      const { red: redTeamName, blue: blueTeamName } = getTeamNames();
      redTeamLabel.textContent = redTeamName + " team";
      blueTeamLabel.textContent = blueTeamName + " team";

      const redList = [];
      const blueList = [];

      Object.entries(players || {})
        .sort(([, a], [, b]) => (a.name || "").localeCompare(b.name || ""))
        .forEach(([id, p]) => {
          const team = p.team || "red";
          const hcp = p.handicap ?? "";
          const rowHtml = `
            <div class="player-row" data-player-id="${id}">
              <div class="player-name-cell">
                <input type="text" class="player-name-input" value="${p.name || ""}" />
                <span class="player-team-pill ${team === "red" ? "red" : "blue"}">
                  ${team === "red" ? "R" : "B"}
                </span>
              </div>
              <input type="number" step="0.1" class="player-hcp-input" value="${hcp}" placeholder="0.0" />
              <button type="button" class="btn btn-sm" data-action="deletePlayer">
                ‚úï
              </button>
            </div>
          `;

          if (team === "red") redList.push(rowHtml);
          else blueList.push(rowHtml);
        });

      redPlayersList.innerHTML = redList.join("") || '<div style="font-size:0.78rem;color:#9ca3af;">No red players yet.</div>';
      bluePlayersList.innerHTML = blueList.join("") || '<div style="font-size:0.78rem;color:#9ca3af;">No blue players yet.</div>';
    }

    addPlayerBtn.addEventListener("click", async () => {
      const name = newPlayerNameInput.value.trim();
      const team = newPlayerTeamSelect.value || "red";
      const hcp = parseFloat(newPlayerHcpInput.value || "0") || 0;

      if (!name) {
        playersStatusEl.textContent = "Enter a player name.";
        return;
      }

      try {
        const playerRef = push(playersRef);
        await set(playerRef, {
          name,
          team,
          handicap: hcp,
          mulliganUsed: false,
          reverseMulliganUsed: false,
        });
        newPlayerNameInput.value = "";
        newPlayerHcpInput.value = "";
        playersStatusEl.textContent = "Player added.";
        setTimeout(() => (playersStatusEl.textContent = ""), 2500);
      } catch (err) {
        console.error(err);
        playersStatusEl.textContent = "Failed to add player.";
      }
    });

    function handlePlayerListClick(e) {
      const btn = e.target.closest("button[data-action]");
      const row = e.target.closest(".player-row");
      if (!row) return;
      const playerId = row.getAttribute("data-player-id");
      if (!playerId) return;

      if (btn && btn.dataset.action === "deletePlayer") {
        if (!confirm("Remove this player from the tournament?")) return;
        set(ref(db, `players/${playerId}`), null).catch(console.error);
        return;
      }

      const nameInput = row.querySelector(".player-name-input");
      const hcpInput = row.querySelector(".player-hcp-input");
      if (!nameInput || !hcpInput) return;

      const newName = nameInput.value.trim();
      const newHcp = parseFloat(hcpInput.value || "0") || 0;

      update(ref(db, `players/${playerId}`), {
        name: newName,
        handicap: newHcp,
      }).catch(console.error);
    }

    redPlayersList.addEventListener("change", handlePlayerListClick);
    bluePlayersList.addEventListener("change", handlePlayerListClick);
    redPlayersList.addEventListener("click", handlePlayerListClick);
    bluePlayersList.addEventListener("click", handlePlayerListClick);

    // Matches
    function buildPlayerOptions(team, selectedId, groupType, usedFront, usedBack) {
      const usedSet = groupType === "front" ? usedFront : usedBack;
      const opts = ['<option value="">‚Äî</option>'];

      Object.entries(players || {})
        .filter(([, p]) => (p.team || "red") === team)
        .sort(([, a], [, b]) => (a.name || "").localeCompare(b.name || ""))
        .forEach(([id, p]) => {
          const disabled = usedSet.has(id) && id !== selectedId;
          const label = p.name || "Player";
          opts.push(
            `<option value="${id}" ${id === selectedId ? "selected" : ""} ${disabled ? "disabled" : ""}>${label}</option>`
          );
        });

      return opts.join("");
    }

    function renderMatches() {
      const { red: redTeamName, blue: blueTeamName } = getTeamNames();
      const { usedFront, usedBack } = computeUsedPlayers();

      const renderGroup = (isFront) => {
        const container = isFront ? frontMatchesContainer : backMatchesContainer;
        const startId = isFront ? 1 : 9;
        const endId = isFront ? 8 : 16;
        const html = [];

        for (let id = startId; id <= endId; id++) {
          const m = matches[id] || {};
          const type = m.type || (id <= 8 ? "front" : "back");
          const redPlayers = m.red?.players || [];
          const bluePlayers = m.blue?.players || [];

          const matchTitle = `Match ${id}`;
          const subLabel = type === "front" ? "Front 9" : "Back 9";

          const redOpt1 = buildPlayerOptions(
            "red",
            redPlayers[0] || "",
            type,
            usedFront,
            usedBack
          );
          const redOpt2 = buildPlayerOptions(
            "red",
            redPlayers[1] || "",
            type,
            usedFront,
            usedBack
          );
          const blueOpt1 = buildPlayerOptions(
            "blue",
            bluePlayers[0] || "",
            type,
            usedFront,
            usedBack
          );
          const blueOpt2 = buildPlayerOptions(
            "blue",
            bluePlayers[1] || "",
            type,
            usedFront,
            usedBack
          );

          html.push(`
            <div class="match-row" data-match-id="${id}">
              <div class="match-row-header">
                <div class="match-row-title">${matchTitle}</div>
                <div class="match-row-sub">${subLabel}</div>
              </div>
              <div class="match-row-body">
                <div class="match-side">
                  <div class="match-side-label red">${redTeamName}</div>
                  <select data-side="red" data-slot="0">${redOpt1}</select>
                  <select data-side="red" data-slot="1">${redOpt2}</select>
                </div>
                <div class="vs-label">vs</div>
                <div class="match-side">
                  <div class="match-side-label blue">${blueTeamName}</div>
                  <select data-side="blue" data-slot="0">${blueOpt1}</select>
                  <select data-side="blue" data-slot="1">${blueOpt2}</select>
                </div>
              </div>
            </div>
          `);
        }

        container.innerHTML =
          html.join("") ||
          '<div style="font-size:0.78rem;color:#9ca3af;">No matches defined.</div>';
      };

      renderGroup(true);
      renderGroup(false);
    }

    async function updateMatchAssignment(matchId, side, slot, playerId) {
      const idNum = Number(matchId);
      const type = idNum <= 8 ? "front" : "back";
      const m = matches[matchId] || {};
      const redArr = Array.isArray(m.red?.players) ? [...m.red.players] : [];
      const blueArr = Array.isArray(m.blue?.players) ? [...m.blue.players] : [];

      const idx = Number(slot);
      if (idx < 0 || idx > 1) return;

      if (side === "red") {
        while (redArr.length < 2) redArr.push("");
        redArr[idx] = playerId || "";
      } else {
        while (blueArr.length < 2) blueArr.push("");
        blueArr[idx] = playerId || "";
      }

      try {
        await update(ref(db, `matches/${matchId}`), {
          type,
          red: { players: redArr },
          blue: { players: blueArr },
        });
      } catch (err) {
        console.error(err);
      }
    }

    frontMatchesContainer.addEventListener("change", (e) => {
      const select = e.target.closest("select[data-side]");
      if (!select) return;
      const matchRow = select.closest(".match-row");
      if (!matchRow) return;
      const matchId = matchRow.getAttribute("data-match-id");
      const side = select.getAttribute("data-side");
      const slot = select.getAttribute("data-slot");
      const playerId = select.value || "";
      updateMatchAssignment(matchId, side, slot, playerId);
    });

    backMatchesContainer.addEventListener("change", (e) => {
      const select = e.target.closest("select[data-side]");
      if (!select) return;
      const matchRow = select.closest(".match-row");
      if (!matchRow) return;
      const matchId = matchRow.getAttribute("data-match-id");
      const side = select.getAttribute("data-side");
      const slot = select.getAttribute("data-slot");
      const playerId = select.value || "";
      updateMatchAssignment(matchId, side, slot, playerId);
    });

    // Reset scores (shared logic)
    async function doResetAllScores() {
      adminToolsStatus.textContent = "Resetting scores‚Ä¶";

      const updatesObj = {};
      for (let i = 1; i <= 16; i++) {
        const holes = new Array(18).fill("none");
        updatesObj[`matches/${i}/holes`] = holes;
      }

      await update(ref(db), updatesObj);

      adminToolsStatus.textContent = "All scores reset.";
      setTimeout(() => (adminToolsStatus.textContent = ""), 4000);
    }

    // Reset scores (page button)
    resetScoresBtn.addEventListener("click", async () => {
      const confirmed = confirm(
        "Reset ALL scores for ALL matches? This sets all 18 holes to 'no result' for matches 1‚Äì16."
      );
      if (!confirmed) return;

      try {
        await doResetAllScores();
      } catch (err) {
        console.error(err);
        adminToolsStatus.textContent =
          "Failed to reset scores: " + (err?.code || err?.message || "unknown error");
      }
    });

    // Delete ALL photos (Storage + DB)
    async function deleteAllPhotosInStorage() {
      const roots = ["matchPhotos", "match_photos", "group_photos", "tournamentPhotos"];

      async function deleteFolder(folderRef) {
        const res = await listAll(folderRef);

        // delete files in this folder
        await Promise.all(res.items.map((itemRef) => deleteObject(itemRef)));

        // recurse into subfolders
        await Promise.all(res.prefixes.map((subRef) => deleteFolder(subRef)));
      }

      for (const r of roots) {
        try {
          await deleteFolder(storageRef(storage, r));
        } catch (err) {
          // ignore missing/unauthorized folders; DB deletion still proceeds
          console.warn("Skip delete for", r, err?.code || err?.message || err);
        }
      }
    }

    async function doDeleteAllPhotos() {
      adminToolsStatus.textContent = "Deleting all photos‚Ä¶";
      await deleteAllPhotosInStorage();
      await set(ref(db, "photos"), null);
      adminToolsStatus.textContent = "All photos deleted.";
      setTimeout(() => (adminToolsStatus.textContent = ""), 5000);
    }

    deletePhotosBtn.addEventListener("click", () => {
      const really = confirm(
        "This will permanently delete ALL tournament photos from Storage and the 'photos' node in the database. Are you sure?"
      );
      if (!really) return;

      if (window.requireAdminPassword) {
        window.requireAdminPassword(async () => {
          try {
            await doDeleteAllPhotos();
          } catch (err) {
            console.error(err);
            adminToolsStatus.textContent =
              "Failed to delete photos: " + (err?.code || err?.message || "unknown error");
          }
        }, {
          title: "Confirm photo deletion",
          message: "Re-enter the admin password to delete ALL photos.",
        });
      }
    });

    // MENU ACTIONS (admin code)
    menuClearFeedBtn.addEventListener("click", () => {
      closeMenu();
      if (!confirm("Clear the tournament feed?")) return;

      window.requireAdminCode?.(async () => {
        try {
          adminToolsStatus.textContent = "Clearing feed‚Ä¶";
          await set(ref(db, "tournamentFeed"), null);
          await set(ref(db, "feed"), null); // fallback if your node is named differently
          adminToolsStatus.textContent = "Feed cleared.";
          setTimeout(() => (adminToolsStatus.textContent = ""), 3500);
        } catch (err) {
          console.error(err);
          adminToolsStatus.textContent =
            "Failed to clear feed: " + (err?.code || err?.message || "unknown error");
        }
      }, {
        title: "Clear feed",
        message: "Enter the admin code to clear the tournament feed.",
      });
    });

    menuClearChatBtn.addEventListener("click", () => {
      closeMenu();
      if (!confirm("Clear the chat?")) return;

      window.requireAdminCode?.(async () => {
        try {
          adminToolsStatus.textContent = "Clearing chat‚Ä¶";
          await set(ref(db, "chat"), null);
          await set(ref(db, "chatMessages"), null); // fallback
          await set(ref(db, "messages"), null); // fallback
          adminToolsStatus.textContent = "Chat cleared.";
          setTimeout(() => (adminToolsStatus.textContent = ""), 3500);
        } catch (err) {
          console.error(err);
          adminToolsStatus.textContent =
            "Failed to clear chat: " + (err?.code || err?.message || "unknown error");
        }
      }, {
        title: "Clear chat",
        message: "Enter the admin code to clear the chat.",
      });
    });

    menuDeletePhotosBtn.addEventListener("click", () => {
      closeMenu();
      const really = confirm("Delete ALL photos (Storage + DB)? This cannot be undone.");
      if (!really) return;

      window.requireAdminCode?.(async () => {
        try {
          await doDeleteAllPhotos();
        } catch (err) {
          console.error(err);
          adminToolsStatus.textContent =
            "Failed to delete photos: " + (err?.code || err?.message || "unknown error");
        }
      }, {
        title: "Delete photos",
        message: "Enter the admin code to delete ALL photos.",
      });
    });

    menuResetScoresBtn.addEventListener("click", () => {
      closeMenu();
      const confirmed = confirm("Reset ALL match scoring for matches 1‚Äì16?");
      if (!confirmed) return;

      window.requireAdminCode?.(async () => {
        try {
          await doResetAllScores();
        } catch (err) {
          console.error(err);
          adminToolsStatus.textContent =
            "Failed to reset scores: " + (err?.code || err?.message || "unknown error");
        }
      }, {
        title: "Reset match scores",
        message: "Enter the admin code to reset ALL match scores.",
      });
    });

    // Fall 2025 upload
    menuUploadFall2025Btn.addEventListener("click", () => {
      closeMenu();

      window.requireAdminCode?.(() => {
        fall2025FileInput.value = "";
        fall2025FileInput.click();
      }, {
        title: "Upload Fall 2025 photos",
        message: "Enter the admin code to upload Fall 2025 photos.",
      });
    });

    fall2025FileInput.addEventListener("change", async (e) => {
      const files = Array.from(e.target.files || []).filter(Boolean);
      if (!files.length) return;

      try {
        adminToolsStatus.textContent = `Uploading ${files.length} photo${files.length === 1 ? "" : "s"}‚Ä¶`;

        for (const file of files) {
          const safeName = (file.name || "photo").replace(/[^\w.\-]+/g, "_");
          const path = `tournamentPhotos/fall2025/${Date.now()}_${safeName}`;
          const sref = storageRef(storage, path);

          await uploadBytes(sref, file, { contentType: file.type || "image/jpeg" });
          const url = await getDownloadURL(sref);

          const photoRef = push(ref(db, "photos"));
          await set(photoRef, {
            url,
            storagePath: path,
            createdAt: serverTimestamp(),
            matchId: "FTK Classic - Fall 2025",
            hole: "",
            group: true,
            comment: "FTK Classic - Fall 2025",
          });
        }

        adminToolsStatus.textContent = "Fall 2025 photos uploaded.";
        setTimeout(() => (adminToolsStatus.textContent = ""), 4500);
      } catch (err) {
        console.error(err);
        adminToolsStatus.textContent =
          "Upload failed: " + (err?.code || err?.message || "unknown error");
      }
    });

    // Live subscriptions
    onValue(settingsRef, (snap) => {
      settings = snap.val() || {};
      renderSettings();
      renderMatches();
    });

    onValue(playersRef, (snap) => {
      players = snap.val() || {};
      renderPlayers();
      renderMatches();
    });

    onValue(matchesRef, (snap) => {
      matches = snap.val() || {};
      renderMatches();
    });
  </script>
</body>
</html>
