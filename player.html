<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTK Classic ‚Äì Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="IMG_7296.jpg" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #d1d5db;
      --red: #b91c1c;
      --blue: #1d4ed8;
      --red-soft: #fee2e2;
      --blue-soft: #dbeafe;
      --half-soft: #e5e7eb;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.12);
      --tap-target: 44px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    html,
    body {
      -webkit-text-size-adjust: 100%;
      background: var(--bg);
      color: var(--text);
    }

    body {
      min-height: 100vh;
      padding: 0.75rem;
      touch-action: manipulation;
    }

    @media (min-width: 768px) {
      body {
        max-width: 1100px;
        margin: 0 auto;
      }
    }

    a {
      color: inherit;
      text-decoration: none;
      -webkit-tap-highlight-color: transparent;
    }

    button {
      -webkit-tap-highlight-color: transparent;
    }

    /* HEADER / NAV */

    .site-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .site-header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 0;
    }

    .site-logo {
      height: 32px;
      width: auto;
      border-radius: 0.45rem;
      object-fit: cover;
      background: #e5e7eb;
      flex-shrink: 0;
    }

    .site-title-group {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 0;
    }

    .site-title {
      font-size: 1.05rem;
      font-weight: 700;
      white-space: nowrap;
    }

    .site-subtitle {
      font-size: 0.78rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .nav-links {
      margin-left: auto;
      display: flex;
      gap: 0.4rem;
      flex-wrap: nowrap;
    }

    .nav-btn {
      font-size: 0.85rem;
      border-radius: 999px;
      padding: 0.3rem 0.9rem;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      text-decoration: none;
      white-space: nowrap;
      min-height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }

    .nav-btn.secondary {
      background: #f9fafb;
    }

    .nav-btn.current {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    main {
      margin-top: 0.4rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 0.75rem;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card);
      border-radius: 0.9rem;
      padding: 0.85rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .card-header {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      margin-bottom: 0.45rem;
    }

    .card-title {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .player-header-main {
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .player-name-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
    }

    .player-name {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .player-team-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.22rem 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 0.78rem;
      white-space: nowrap;
    }

    .player-team-badge .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
    }

    .player-team-badge.red {
      background: var(--red-soft);
      border-color: #fecaca;
      color: #7f1d1d;
    }

    .player-team-badge.red .dot {
      background: var(--red);
    }

    .player-team-badge.blue {
      background: var(--blue-soft);
      border-color: #bfdbfe;
      color: #1e3a8a;
    }

    .player-team-badge.blue .dot {
      background: var(--blue);
    }

    .player-meta {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
      margin-top: 0.35rem;
    }

    @media (max-width: 480px) {
      .player-meta {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .player-meta-item {
      font-size: 0.8rem;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .player-meta-label {
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-size: 0.72rem;
    }

    .player-meta-value {
      font-size: 0.88rem;
      color: var(--text);
      font-weight: 500;
    }

    .player-note {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.4rem;
    }

    .player-note strong {
      color: var(--text);
      font-weight: 600;
    }

    .player-error {
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: #b91c1c;
      background: #fef2f2;
      border-radius: 0.7rem;
      padding: 0.45rem 0.6rem;
      border: 1px solid #fecaca;
    }

    /* ACHIEVEMENTS */

    .player-achievements {
      margin-top: 0.55rem;
      border-top: 1px dashed #e5e7eb;
      padding-top: 0.45rem;
    }

    .player-achievements-title {
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }

    .player-achievements-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .player-achievement-item {
      font-size: 0.8rem;
      color: #374151;
    }

    .player-achievement-link {
      color: #111827;
      text-decoration: underline;
      text-decoration-thickness: 1px;
      text-underline-offset: 2px;
    }

    .player-achievement-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 0.78rem;
    }

    .player-achievement-icon {
      font-size: 0.9rem;
    }

    .player-achievements-empty {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }

    .player-next-achievement {
      margin-top: 0.6rem;
    }

    .player-next-title {
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin-bottom: 0.3rem;
    }

    .player-next-bar-outer {
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      position: relative;
    }

    .player-next-bar-inner {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #15803d);
      width: 0%;
      transition: width 0.25s ease-out;
    }

    .player-next-text {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }

    /* MATCHES */

    .matches-list {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .match-card {
      border-radius: 0.8rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 0.6rem 0.65rem 0.7rem 0.65rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .match-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
    }

    .match-header-main {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .match-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .match-status-text {
      font-size: 0.8rem;
      color: #374151;
    }

    .match-type-pill {
      font-size: 0.75rem;
      padding: 0.1rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      white-space: nowrap;
    }

    .team-row {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.82rem;
      color: #374151;
    }

    .team-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .team-name {
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .team-name.red {
      color: #b91c1c;
    }

    .team-name.blue {
      color: #1d4ed8;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.12rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 0.75rem;
      background: #ffffff;
      color: #374151;
    }

    .status-chip.red {
      background: #fef2f2;
      border-color: #fecaca;
      color: #7f1d1d;
    }

    .status-chip.blue {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: #1e3a8a;
    }

    .status-chip.half {
      background: #f3f4f6;
      border-color: #e5e7eb;
      color: #374151;
    }

    .empty-state {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: center;
      padding: 0.75rem 0.5rem;
    }

    .card-footer-links {
      display: flex;
      justify-content: flex-end;
      margin-top: 0.35rem;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .card-footer-links a {
      text-decoration: underline;
      text-decoration-thickness: 1px;
      text-underline-offset: 2px;
    }

    .card-footer-links span {
      opacity: 0.7;
    }

    .card-footer-links span + span::before {
      content: "‚Ä¢";
      margin: 0 0.4rem;
    }

    .matches-card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.4rem;
      margin-bottom: 0.35rem;
    }

    .matches-card-title {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .matches-card-subtitle {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .matches-card-subtitle span {
      font-weight: 600;
      color: var(--text);
    }

    .match-item {
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 0.6rem 0.65rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .match-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.35rem;
    }

    .match-item-title {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .match-item-type {
      font-size: 0.78rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }

    .match-item-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.82rem;
      color: #374151;
      flex-wrap: wrap;
    }

    .match-item-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.25rem;
      font-size: 0.78rem;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .match-item-links {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .match-link {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      padding: 0.12rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 0.78rem;
      text-decoration: none;
      color: #111827;
    }

    .match-link .icon {
      font-size: 0.9rem;
    }

    .match-item-status {
      font-size: 0.75rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }

    .match-item-status.final {
      border-color: #15803d;
      background: #dcfce7;
      color: #166534;
    }

    .match-item-status.live {
      border-color: #f97316;
      background: #ffedd5;
      color: #9a3412;
    }

    .match-item-status.upcoming {
      border-color: #e5e7eb;
      background: #f9fafb;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="site-header">
      <div class="site-header-left">
        <img src="IMG_7296.jpg" alt="FTK Classic logo" class="site-logo" />
        <div class="site-title-group">
          <div class="site-title">FTK Classic</div>
          <div id="headerSubtitle" class="site-subtitle">Player profile</div>
        </div>
      </div>
      <nav class="nav-links">
        <a href="index.html" class="nav-btn secondary">Home</a>
        <a href="spectator.html" class="nav-btn secondary">Scores</a>
      </nav>
    </header>

    <main>
      <section class="layout">
        <!-- LEFT: Player info + achievements -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Player</div>
            <div class="card-subtitle">Profile and achievements.</div>
          </div>

          <div class="player-header-main">
            <div class="player-name-row">
              <div id="playerName" class="player-name">Player</div>
              <div id="playerTeamBadge" class="player-team-badge" style="display:none;">
                <span class="dot"></span>
                <span id="playerTeamBadgeLabel"></span>
              </div>
            </div>

            <div class="player-meta">
              <div class="player-meta-item">
                <div class="player-meta-label">Handicap</div>
                <div id="playerHandicap" class="player-meta-value">‚Äî</div>
              </div>
              <div class="player-meta-item">
                <div class="player-meta-label">Player code</div>
                <div id="playerCode" class="player-meta-value">‚Äî</div>
              </div>
              <div id="playerTeamRow" class="player-meta-item">
                <div class="player-meta-label">Team</div>
                <div id="playerTeam" class="player-meta-value">‚Äî</div>
              </div>
            </div>

            <!-- Holes won / lost / halved line -->
            <div id="playerStats" class="player-note" style="margin-top:0.5rem;"></div>

            <div id="playerAchievementsSection" class="player-achievements" style="display:none;">
              <div class="player-achievements-title">Achievements</div>
              <ul id="playerAchievementsList" class="player-achievements-list"></ul>

              <!-- Next achievement progression -->
              <div class="player-next-achievement" id="playerNextAchievement" style="display:none;">
                <div class="player-next-title">Next achievement</div>
                <div class="player-next-bar-outer">
                  <div class="player-next-bar-inner" id="playerNextAchievementBar"></div>
                </div>
                <div class="player-next-text" id="playerNextAchievementText"></div>
              </div>
            </div>
          </div>

          <div id="playerError" class="player-error" style="display:none;"></div>
        </section>

        <!-- RIGHT: Matches for this player -->
        <section class="card">
          <div class="matches-card-header-row">
            <div class="matches-card-title">Matches</div>
          </div>
          <div class="card-subtitle">Every FTK Classic match this player is in.</div>
          <div id="matchesList" class="matches-list">
            <div class="empty-state">Loading matches‚Ä¶</div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD5fk91DPgPBkJ3_xGnNntD3PQbi5Ib3kg",
      authDomain: "ftkclassicdb.firebaseapp.com",
      databaseURL: "https://ftkclassicdb-default-rtdb.firebaseio.com",
      projectId: "ftkclassicdb",
      storageBucket: "ftkclassicdb.firebasestorage.app",
      messagingSenderId: "963469808092",
      appId: "1:963469808092:web:e6e789ce20ef46404b3f19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const settingsRef = ref(db, "settings");
    const playersRef = ref(db, "players");
    const matchesRef = ref(db, "matches");
    const manualStatsRef = ref(db, "manualStats/players");

    const PLAYER_CODES = {
      "3601": "David Wolf",
      "3602": "Jake Smith",
      "3603": "Jon Wall",
      "3604": "Justin Vaughn",
      "3605": "Will Miller",
      "3606": "Ivan Bolds",
      "3607": "Taylor Harbin",
      "3608": "Eric Tomeo",
      "3609": "Matt Ruff",
      "3610": "Eric Crowe",
      "3611": "Brett Cooper",
      "3612": "Jordan Fiedler",
      "3613": "Michael Godwin",
      "3614": "Tyler Huff"
    };

    const STATIC_PLAYER_ACHIEVEMENTS = {
      "david wolf": [
        "Fall 2025 FTK Classic champion ‚Äì Dawgleg GC"
      ],
      "jon wall": [
        "Fall 2025 FTK Classic champion ‚Äì Dawgleg GC"
      ],
      "ivan bolds": [
        "Fall 2025 FTK Classic champion ‚Äì Dawgleg GC"
      ],
      "will miller": [
        "Fall 2025 FTK Classic champion ‚Äì Dawgleg GC"
      ]
    };

    // Hole-win achievement thresholds
    const HOLE_ACHIEVEMENT_THRESHOLDS = [3, 10, 20, 30];

    function getCodeForName(name) {
      if (!name) return null;
      const target = normalizeName(name);
      for (const [code, nm] of Object.entries(PLAYER_CODES)) {
        if (normalizeName(nm) === target) return code;
      }
      return null;
    }

    function normalizeName(s) {
      return String(s || "")
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim()
        .toLowerCase();
    }

    function getLastName(fullName) {
      if (!fullName) return "";
      const parts = String(fullName).trim().split(/\s+/);
      return parts[parts.length - 1];
    }

    function getQueryParams() {
      const params = new URLSearchParams(window.location.search || "");
      const out = {};
      for (const [k, v] of params.entries()) {
        out[k] = v;
      }
      return out;
    }

    function getTeamNames(settings) {
      const t = (settings && settings.teamNames) || {};
      return {
        red: t.red || "Red",
        blue: t.blue || "Blue"
      };
    }

    function computeMatchType(mid, m) {
      if (m && m.type) return m.type;
      const n = Number(mid);
      if (!Number.isFinite(n)) return "front";
      return n > 8 ? "back" : "front";
    }

    function computeMatchStatus(mid, m) {
      if (!m) {
        return {
          statusTag: "upcoming",
          statusText: "Not started",
          detailText: ""
        };
      }

      const type = computeMatchType(mid, m);
      const holes = m.holes || Array(18).fill("none");
      const start = type === "back" ? 9 : 0;
      const end = start + 9;

      let diff = 0;
      let played = 0;
      let lastHole = null;

      for (let i = start; i < end; i++) {
        const res = holes[i];
        if (!res || res === "none") continue;
        played++;
        lastHole = i + 1;
        if (res === "red") diff++;
        else if (res === "blue") diff--;
      }

      if (!played) {
        return {
          statusTag: "upcoming",
          statusText: "Not started",
          detailText: ""
        };
      }

      const holesLeft = (end - start) - played;
      const absDiff = Math.abs(diff);

      if (holesLeft === 0 || absDiff > holesLeft) {
        if (diff === 0) {
          return {
            statusTag: "final",
            statusText: "Final ‚Äì All square",
            detailText: ""
          };
        }

        const leader = diff > 0 ? "Red" : "Blue";
        const margin = absDiff;
        const remaining = holesLeft;
        return {
          statusTag: "final",
          statusText: `Final ‚Äì ${leader} ${margin} & ${remaining}`,
          detailText: ""
        };
      }

      if (diff === 0) {
        return {
          statusTag: "live",
          statusText: `Thru ${lastHole} ‚Äì All square`,
          detailText: ""
        };
      }

      const leader = diff > 0 ? "Red" : "Blue";
      return {
        statusTag: "live",
        statusText: `Thru ${lastHole} ‚Äì ${leader} ${absDiff} up`,
        detailText: ""
      };
    }

    function computeMatchWinner(matchId, match) {
      const holes = match.holes || Array(18).fill("none");
      let redUp = 0;
      let blueUp = 0;

      for (let i = 0; i < holes.length; i++) {
        const res = holes[i];
        if (!res || res === "none") continue;

        if (res === "red") redUp++;
        else if (res === "blue") blueUp++;
      }

      if (redUp === blueUp) return null;
      return redUp > blueUp ? "red" : "blue";
    }

    function renderAchievements(fullName, holesWon, matchWins) {
      const key = normalizeName(fullName || "");
      const staticList = STATIC_PLAYER_ACHIEVEMENTS[key] || [];

      // Build achievement objects
      const achievements = [];

      // Champions (link to past winners)
      for (const text of staticList) {
        achievements.push({ text, link: "past_winners.html", trophy: true });
      }

      // Match win achievement
      if (matchWins > 0) {
        const text =
          matchWins === 1
            ? "Won a match at the FTK Classic"
            : `Won ${matchWins} matches at the FTK Classic`;
        achievements.push({ text, link: null, trophy: true });
      }

      // Hole win achievements
      for (const threshold of HOLE_ACHIEVEMENT_THRESHOLDS) {
        if (holesWon >= threshold) {
          const text =
            threshold === 3
              ? "Won 3 FTK Classic holes"
              : `Won ${threshold}+ FTK Classic holes`;
          achievements.push({ text, link: null, trophy: false });
        }
      }

      // Render
      const section = playerAchievementsSectionEl;
      if (!section) return;

      if (!achievements.length) {
        section.style.display = "block";
        playerAchievementsListEl.innerHTML = "";
        playerAchievementsListEl.insertAdjacentHTML(
          "beforeend",
          `<li class="player-achievements-empty">None</li>`
        );
      } else {
        section.style.display = "block";
        playerAchievementsListEl.innerHTML = achievements
          .map((ach) => {
            const icon = ach.trophy ? "üèÜ" : "‚≠ê";
            const inner = ach.link
              ? `<span class="player-achievement-icon">${icon}</span><a href="${ach.link}" class="player-achievement-link">${ach.text}</a>`
              : `<span class="player-achievement-icon">${icon}</span><span>${ach.text}</span>`;
            return `<li class="player-achievement-item"><span class="player-achievement-badge">${inner}</span></li>`;
          })
          .join("");
      }

      // Next achievement progress bar (holes-based)
      if (!playerNextAchievementEl || !playerNextAchievementBarEl || !playerNextAchievementTextEl) {
        return;
      }

      playerNextAchievementEl.style.display = "block";

      const thresholds = HOLE_ACHIEVEMENT_THRESHOLDS.slice().sort((a, b) => a - b);
      let nextThreshold = null;
      let prevThreshold = 0;

      for (const t of thresholds) {
        if (holesWon < t) {
          nextThreshold = t;
          break;
        }
        prevThreshold = t;
      }

      if (nextThreshold === null) {
        playerNextAchievementTextEl.textContent = `${holesWon} lifetime FTK Classic holes won`;
        playerNextAchievementBarEl.style.width = "100%";
        return;
      }

      const span = nextThreshold - prevThreshold;
      const offset = holesWon - prevThreshold;
      const progress = Math.max(0, Math.min(1, span ? offset / span : 0));

      playerNextAchievementTextEl.textContent = `${holesWon} / ${nextThreshold} holes`;
      playerNextAchievementBarEl.style.width = `${progress * 100}%`;
    }

    function getMatchesForPlayer(playerId) {
      const out = [];
      const entries = Object.entries(matches || {});
      for (const [mid, m] of entries) {
        const redIds = (m.red && m.red.players) || [];
        const blueIds = (m.blue && m.blue.players) || [];
        const isRed = redIds.includes(playerId);
        const isBlue = blueIds.includes(playerId);
        if (!isRed && !isBlue) continue;

        const type = computeMatchType(mid, m);
        out.push({ id: mid, match: m, side: isRed ? "red" : "blue", type });
      }

      out.sort((a, b) => Number(a.id) - Number(b.id));

      if (requestedNine === "front" || requestedNine === "back") {
        const target = requestedNine;
        out.sort((a, b) => {
          const ta = a.type === target ? 0 : 1;
          const tb = b.type === target ? 0 : 1;
          if (ta !== tb) return ta - tb;
          return Number(a.id) - Number(b.id);
        });
      }

      return out;
    }

    const headerSubtitleEl = document.getElementById("headerSubtitle");
    const playerNameEl = document.getElementById("playerName");
    const playerTeamBadgeEl = document.getElementById("playerTeamBadge");
    const playerTeamRowEl = document.getElementById("playerTeamRow");
    const playerTeamEl = document.getElementById("playerTeam");
    const playerHandicapEl = document.getElementById("playerHandicap");
    const playerCodeEl = document.getElementById("playerCode");
    const matchesListEl = document.getElementById("matchesList");
    const playerErrorEl = document.getElementById("playerError");
    const playerAchievementsSectionEl = document.getElementById("playerAchievementsSection");
    const playerAchievementsListEl = document.getElementById("playerAchievementsList");
    const playerNextAchievementEl = document.getElementById("playerNextAchievement");
    const playerNextAchievementBarEl = document.getElementById("playerNextAchievementBar");
    const playerNextAchievementTextEl = document.getElementById("playerNextAchievementText");
    const playerStatsEl = document.getElementById("playerStats");

    let settings = {};
    let players = {};
    let matches = {};
    let manualStats = {};

    let settingsLoaded = false;
    let playersLoaded = false;
    let matchesLoaded = false;
    let manualStatsLoaded = false;

    const urlParams = getQueryParams();
    const requestedCode = urlParams.code || null;
    const requestedId = urlParams.id || urlParams.playerId || null;
    const requestedName = urlParams.name || null;
    const requestedNine = urlParams.nine || null;

    function resolvePlayerId() {
      if (requestedId && players[requestedId]) {
        return requestedId;
      }

      if (requestedCode) {
        const codeName = PLAYER_CODES[requestedCode];
        if (codeName) {
          const target = normalizeName(codeName);
          const entries = Object.entries(players || {});
          for (const [pid, p] of entries) {
            if (normalizeName(p.name || "") === target) {
              return pid;
            }
          }
        }
      }

      if (requestedName) {
        const target = normalizeName(requestedName);
        const entries = Object.entries(players || {});
        for (const [pid, p] of entries) {
          if (normalizeName(p.name || "") === target) {
            return pid;
          }
        }
      }

      return null;
    }

    function render() {
      if (!settingsLoaded || !playersLoaded || !matchesLoaded || !manualStatsLoaded) return;

      const playerId = resolvePlayerId();

      // Hide the Team row entirely (per request)
      if (playerTeamRowEl) {
        playerTeamRowEl.style.display = "none";
      }

      if (!playerId) {
        playerNameEl.textContent = "Player not found";
        playerErrorEl.textContent =
          "We couldn't match this URL to a player. Try linking with ?code=3601 or ?name=First%20Last.";
        playerErrorEl.style.display = "block";
        playerTeamBadgeEl.style.display = "none";
        if (playerTeamEl) playerTeamEl.textContent = "‚Äî";
        if (playerHandicapEl) playerHandicapEl.textContent = "‚Äî";
        if (playerCodeEl) playerCodeEl.textContent = "‚Äî";
        headerSubtitleEl.textContent = "Player profile";
        renderAchievements("", 0, 0);
        if (playerStatsEl) playerStatsEl.textContent = "";
        return;
      }

      const p = players[playerId] || {};
      const fullName = p.name || "Player";
      const team = p.team || "red";
      const handicap = p.handicap ?? "‚Äî";
      const teamNames = getTeamNames(settings);
      const codeForPlayer = getCodeForName(fullName);

      playerNameEl.textContent = fullName;
      headerSubtitleEl.textContent = `Player profile ‚Äì ${fullName}`;
      playerErrorEl.style.display = "none";

      const teamLabel =
        team === "blue" ? `${teamNames.blue} team` : `${teamNames.red} team`;
      if (playerTeamEl) playerTeamEl.textContent = teamLabel;

      playerHandicapEl.textContent = handicap === "‚Äî" ? "‚Äî" : String(handicap);
      playerCodeEl.textContent = codeForPlayer || "‚Äî";

      playerTeamBadgeEl.style.display = "inline-flex";
      const badgeLabel = team === "blue" ? `${teamNames.blue} team` : `${teamNames.red} team`;
      playerTeamBadgeEl.className =
        "player-team-badge " + (team === "blue" ? "blue" : "red");
      playerTeamBadgeEl.innerHTML = `
        <span class="dot"></span>
        <span id="playerTeamBadgeLabel">${badgeLabel}</span>
      `;

      const playerMatches = getMatchesForPlayer(playerId);

      // Count unique matchups (ignoring separate Front 9 / Back 9 records)
      const uniqueMatchups = new Set();
      for (const pm of playerMatches) {
        const m = pm.match || {};
        const redIds = ((m.red && m.red.players) || []).slice().sort().join(",");
        const blueIds = ((m.blue && m.blue.players) || []).slice().sort().join(",");
        uniqueMatchups.add(redIds + "|" + blueIds);
      }
      const matchCount = uniqueMatchups.size;

      // Aggregate holes + match wins (live)
      let holesWon = 0;
      let holesLost = 0;
      let holesHalved = 0;
      let matchWins = 0;

      for (const pm of playerMatches) {
        const m = pm.match;
        const side = pm.side; // "red" or "blue"
        const type = pm.type; // "front" or "back"

        const holes = m.holes || Array(18).fill("none");
        const start = type === "back" ? 9 : 0;
        const end = start + 9;

        for (let i = start; i < end; i++) {
          const res = holes[i];
          if (!res || res === "none") continue;

          if (res === "half" || res === "halved") {
            holesHalved++;
          } else if (res === "red" || res === "blue") {
            if (res === side) {
              holesWon++;
            } else {
              holesLost++;
            }
          }
        }

        const winner = computeMatchWinner(pm.id, m);
        if (winner && winner === side) {
          matchWins++;
        }
      }

      const manual = (manualStats && manualStats[playerId]) || {};
      const manualHoleWins = Number(manual.holeWins ?? 0) || 0;
      const manualMatchWins = Number(manual.matchWins ?? 0) || 0;
      const totalHolesForAchievements = holesWon + manualHoleWins;
      const totalMatchWinsForAchievements = matchWins + manualMatchWins;

      if (playerStatsEl) {
        const totalPlayed = holesWon + holesLost + holesHalved;
        if (totalPlayed === 0) {
          playerStatsEl.textContent = "Holes so far: no holes recorded yet.";
        } else {
          playerStatsEl.textContent =
            "Holes so far: " +
            holesWon + " won ¬∑ " +
            holesLost + " lost ¬∑ " +
            holesHalved + " halved";
        }
      }

      // Achievements & next achievement bar (includes manual historical stats)
      renderAchievements(fullName, totalHolesForAchievements, totalMatchWinsForAchievements);

      if (!playerMatches.length) {
        matchesListEl.innerHTML =
          '<div class="empty-state">This player is not currently assigned to any matches.</div>';
        return;
      }

      const html = playerMatches
        .map(({ id: mid, match: m, side, type }) => {
          const typeLabel = type === "back" ? "Back 9" : "Front 9";

          const redIds = (m.red && m.red.players) || [];
          const blueIds = (m.blue && m.blue.players) || [];
          const redNames = redIds
            .map((pid) => players[pid]?.name)
            .filter(Boolean)
            .map(getLastName);
          const blueNames = blueIds
            .map((pid) => players[pid]?.name)
            .filter(Boolean)
            .map(getLastName);

          const redPair = redNames.length ? redNames.join(" / ") : "Red pair";
          const bluePair = blueNames.length ? blueNames.join(" / ") : "Blue pair";

          const { statusTag, statusText } = computeMatchStatus(
            mid,
            m
          );

          const statusClass =
            statusTag === "final"
              ? "match-item-status final"
              : statusTag === "live"
              ? "match-item-status live"
              : "match-item-status upcoming";

          const codeForPlayerLink = getCodeForName(fullName);

          const linksHtml = `
            <a href="match_spectator.html?id=${mid}" class="match-link">
              <span class="icon">üëÄ</span>
              <span>View as spectator</span>
            </a>
            <a href="${
              codeForPlayerLink
                ? `match.html?code=${encodeURIComponent(codeForPlayerLink)}&match=${encodeURIComponent(mid)}`
                : `match.html?match=${encodeURIComponent(mid)}`
            }" class="match-link">
              <span class="icon">üõ†Ô∏è</span>
              <span>Match admin</span>
            </a>
          `;

          return `
            <div class="match-item">
              <div class="match-item-header">
                <div class="match-item-title">Match ${mid}</div>
                <div class="match-item-type">${typeLabel}</div>
              </div>
              <div class="match-item-line">
                <span>${redPair} vs ${bluePair}</span>
                <span class="${statusClass}">${statusText}</span>
              </div>
              <div class="match-item-footer">
                <div class="match-item-links">
                  ${linksHtml}
                </div>
              </div>
            </div>
          `;
        })
        .join("");

      matchesListEl.innerHTML = html;
    }

    onValue(settingsRef, (snap) => {
      settings = snap.val() || {};
      settingsLoaded = true;
      render();
    });

    onValue(playersRef, (snap) => {
      players = snap.val() || {};
      playersLoaded = true;
      render();
    });

    onValue(matchesRef, (snap) => {
      matches = snap.val() || {};
      matchesLoaded = true;
      render();
    });

    onValue(manualStatsRef, (snap) => {
      manualStats = snap.val() || {};
      manualStatsLoaded = true;
      render();
    });
  </script>
</body>
</html>
